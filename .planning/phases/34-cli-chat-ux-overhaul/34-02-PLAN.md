---
phase: 34-cli-chat-ux-overhaul
plan: 02
type: execute
wave: 2
depends_on: [34-01]
files_modified:
  - packages/cli/src/components/InlineToolCall.tsx
  - packages/cli/src/components/InlineApproval.tsx
  - packages/cli/src/components/InlineDiff.tsx
  - packages/cli/src/components/MessageBubble.tsx
  - packages/cli/src/components/Chat.tsx
  - packages/cli/src/components/TodoPanel.tsx
  - packages/cli/src/components/ConversationScroll.tsx
  - packages/cli/package.json
autonomous: true
requirements: [CLIX-05, CLIX-06, CLIX-07, CLIX-08]

must_haves:
  truths:
    - "Tool calls render inline in the conversation with colored icon prefixes per tool type"
    - "Approval dialogs appear as boxed prompts in the conversation area, not replacing the input"
    - "Input zone stays visible (disabled) while approval is pending"
    - "File diffs render inline with red removed lines and green added lines"
    - "Long diffs are auto-collapsed with a summary showing line count"
    - "Todos display in a tree-style layout with colored status icons"
  artifacts:
    - path: "packages/cli/src/components/InlineToolCall.tsx"
      provides: "Colored icon + tool name inline display"
      contains: "TOOL_ICONS"
    - path: "packages/cli/src/components/InlineApproval.tsx"
      provides: "Boxed approval dialog for conversation area"
      contains: "borderStyle"
    - path: "packages/cli/src/components/InlineDiff.tsx"
      provides: "Red/green line diff rendering"
      contains: "diffLines"
    - path: "packages/cli/src/components/TodoPanel.tsx"
      provides: "Tree-style todo display with status icons"
      contains: "completed"
  key_links:
    - from: "packages/cli/src/components/ConversationScroll.tsx"
      to: "packages/cli/src/components/InlineApproval.tsx"
      via: "renders approval inside scroll area"
      pattern: "InlineApproval"
    - from: "packages/cli/src/components/MessageBubble.tsx"
      to: "packages/cli/src/components/InlineToolCall.tsx"
      via: "delegates tool_call rendering"
      pattern: "InlineToolCall"
    - from: "packages/cli/src/components/InlineDiff.tsx"
      to: "diff"
      via: "npm package for structured diff generation"
      pattern: "diffLines"
---

<objective>
Add inline rendering for tool calls, approval dialogs, file diffs, and restyled todo display within the new fullscreen conversation area. Tool calls show as compact colored entries, approvals render as boxed dialogs in the conversation flow (input stays visible), file diffs show red/green line changes, and todos use a Claude Code-style tree layout.

Purpose: Complete the Claude Code-style UX by replacing the separate ToolPanel and input-replacing approval pattern with inline rendering, and adding diff visualization that was previously deferred (CLIF-01 from future requirements, now delivered as part of this overhaul).

Output: All tool interactions, approvals, diffs, and todos render inline in the conversation scroll area with appropriate visual styling.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-cli-chat-ux-overhaul/34-CONTEXT.md
@.planning/phases/34-cli-chat-ux-overhaul/34-RESEARCH.md
@.planning/phases/34-cli-chat-ux-overhaul/34-01-SUMMARY.md

Key files from Plan 01:
@packages/cli/src/components/Chat.tsx
@packages/cli/src/components/ConversationScroll.tsx
@packages/cli/src/components/MessageBubble.tsx
@packages/cli/src/components/ToolApprovalPrompt.tsx
@packages/cli/src/components/SkillApprovalPrompt.tsx
@packages/cli/src/components/PreflightChecklist.tsx
@packages/cli/src/components/TodoPanel.tsx
@packages/cli/src/components/ToolPanel.tsx
@packages/cli/src/hooks/useChat.ts
@packages/cli/src/lib/gateway-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineToolCall, InlineApproval, and refactor approval flow</name>
  <files>
    packages/cli/src/components/InlineToolCall.tsx
    packages/cli/src/components/InlineApproval.tsx
    packages/cli/src/components/MessageBubble.tsx
    packages/cli/src/components/Chat.tsx
    packages/cli/src/components/ConversationScroll.tsx
  </files>
  <action>
    **Install diff package** (needed in Task 2 but install now to avoid build issues):
    ```bash
    cd /Users/drew-mini/Documents/GitHub/tek && pnpm add diff --filter @tek/cli && pnpm add -D @types/diff --filter @tek/cli
    ```

    **Create InlineToolCall.tsx** -- Compact colored tool call display for conversation flow:

    Define a TOOL_ICONS mapping (from RESEARCH.md):
    ```typescript
    const TOOL_ICONS: Record<string, { icon: string; color: string }> = {
      bash_command:    { icon: "\u25B6", color: "green" },    // triangle right
      read_file:       { icon: "\u25CF", color: "cyan" },     // filled circle
      write_file:      { icon: "\u270E", color: "blue" },     // pencil
      update_file:     { icon: "\u270E", color: "blue" },     // pencil
      web_search:      { icon: "\u25C6", color: "magenta" },  // diamond
      skill_register:  { icon: "\u2605", color: "yellow" },   // star
      todo_write:      { icon: "\u2610", color: "white" },    // ballot box
      default:         { icon: "\u25C7", color: "gray" },     // diamond outline
    };
    ```

    Props: `{ toolName, status, input?, output?, args? }`

    Render:
    - Single line: `[icon] toolName(argPreview) [statusIcon]`
    - Icon colored per TOOL_ICONS mapping
    - argPreview: first argument value truncated to 40 chars (e.g., for read_file show the path, for bash_command show the command)
    - Status icon: green checkmark for complete, red X for error, yellow dots for pending
    - Entire line is compact -- no multiline, no expansion
    - For bash_command type, show `$ command` format instead of `toolName(args)` to match Claude Code style

    **Create InlineApproval.tsx** -- Boxed approval dialog for the conversation area:

    This component COMBINES the logic from ToolApprovalPrompt, SkillApprovalPrompt, and PreflightChecklist into one unified inline component.

    Props: `{ type: 'tool' | 'skill' | 'preflight', toolName?, toolCallId?, args?, checklist?, onToolResponse?, onPreflightResponse?, isActive }`

    Render with `borderStyle="round"` and `borderColor="yellow"` (matching existing approval style):
    - Header: "Tool Approval Required" / "Skill Registration" / "Pre-flight Checklist" based on type
    - Body: Tool name + argument preview (for tool/skill), or step list (for preflight)
    - Options line: `[Y] Approve  [N] Deny  [S] Session approve` (for tool type)
    - Uses `useInput` with `isActive` prop to capture Y/N/S keys
    - IMPORTANT: isActive should be TRUE only when this approval is the active focus (not during streaming, not when input is active)

    **Update MessageBubble.tsx** -- Replace tool_call and bash_command rendering with InlineToolCall:
    - Import InlineToolCall
    - For `case "tool_call"`: render `<InlineToolCall toolName={message.toolName} status={message.status} input={message.input} />`
    - For `case "bash_command"`: render `<InlineToolCall toolName="bash_command" status={message.exitCode === 0 ? "complete" : message.exitCode === undefined ? "pending" : "error"} input={message.command} />`
    - Keep text, reasoning, sources cases unchanged

    **Update Chat.tsx** -- Refactor approval rendering:
    - Remove the conditional rendering at the bottom that swaps between approval prompts and InputBar
    - Instead, InputBar is ALWAYS rendered (with `isActive={!isStreaming && !pendingApproval && !pendingPreflight}`)
    - Pass approval data to ConversationScroll so it can render InlineApproval at the bottom of the scroll
    - ConversationScroll receives: `pendingApproval`, `pendingPreflight`, `onToolApproval`, `onPreflightApproval` props
    - When pendingApproval or pendingPreflight is set, ConversationScroll renders InlineApproval as the last item in the scroll

    **Update ConversationScroll.tsx** -- Add approval rendering:
    - Accept approval-related props
    - When pendingApproval is provided, render `<InlineApproval type={isSkill ? 'skill' : 'tool'} ... isActive={true} />` at the bottom of the scroll content
    - When pendingPreflight is provided, render `<InlineApproval type="preflight" ... isActive={true} />` at the bottom
    - The approval dialog scrolls into view with the conversation

    NOTE: The old ToolApprovalPrompt.tsx, SkillApprovalPrompt.tsx, and PreflightChecklist.tsx files can remain in the codebase (avoid deleting during execution) but should no longer be imported by Chat.tsx. They may be cleaned up later.

    Similarly, ToolPanel.tsx is no longer used -- the live tool call display in Chat.tsx can be replaced by the inline rendering in ConversationScroll. Remove the ToolPanel rendering from Chat.tsx (the tool calls are already added to messages[] via useChat, so they appear via MessageBubble).
  </action>
  <verify>
    1. `cd /Users/drew-mini/Documents/GitHub/tek && npx turbo build --filter=@tek/cli` -- builds without TypeScript errors
    2. Verify InlineToolCall.tsx contains TOOL_ICONS mapping
    3. Verify InlineApproval.tsx has borderStyle="round" and useInput handler
    4. Verify Chat.tsx no longer conditionally replaces InputBar with approval prompts
    5. Verify MessageBubble.tsx imports and uses InlineToolCall for tool_call and bash_command cases
  </verify>
  <done>
    Tool calls render inline with colored icons per tool type. Approval dialogs appear as boxed prompts inside the conversation scroll area. InputBar is always visible at the bottom (disabled during approvals). ToolPanel and the old approval-replaces-input pattern are no longer used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create InlineDiff, restyle TodoPanel, and wire diff rendering</name>
  <files>
    packages/cli/src/components/InlineDiff.tsx
    packages/cli/src/components/TodoPanel.tsx
    packages/cli/src/components/MessageBubble.tsx
    packages/cli/src/lib/gateway-client.ts
  </files>
  <action>
    **Create InlineDiff.tsx** -- Red/green line diff display with collapsible behavior:

    Import `diffLines` from the `diff` package (installed in Task 1).

    Props: `{ oldText: string, newText: string, fileName: string, collapsed?: boolean }`

    Implementation:
    - Use `diffLines(oldText, newText)` to get structured diff changes
    - Count total changed lines: sum of `count` for added/removed changes
    - **Collapsed view** (default for diffs with >20 changed lines):
      - Render: `[pencil icon] fileName (N lines changed)` in blue with dimmed count
      - Single line, compact
    - **Expanded view** (default for diffs with <=20 lines, or when expanded):
      - Render file header: `[pencil icon] fileName` in blue bold
      - For each change:
        - Added lines: `<Text color="green">{"+ "}{line}</Text>` for each line in change.value
        - Removed lines: `<Text color="red">{"- "}{line}</Text>` for each line in change.value
        - Unchanged: skip (context lines add noise in terminal -- only show changes)
    - Split `change.value` by `\n` to render individual lines (diffLines returns multi-line strings per change)
    - Trim trailing empty line from each change.value.split("\n") (diffLines includes trailing newline)

    NOTE: The diff display is currently for future use. The gateway does not yet send old/new file content in tool results. To make this useful NOW, detect write_file/update_file tool results in MessageBubble and, if the result contains diff-like content, render it with InlineDiff. For the MVP, create the component with a simple API so it can be wired in when the gateway supports it. Add it to MessageBubble's tool_call case as an optional enhancement: if `message.output` contains lines starting with `+` or `-`, render as diff; otherwise render as plain text.

    **Restyle TodoPanel.tsx** -- Claude Code-style nested tree display:

    Update the visual style to match Claude Code's task tree:
    - Status icons (Unicode, colored):
      - completed: `\u2714` (heavy check mark) in green
      - in_progress: Spinner from @inkjs/ui (keep existing)
      - pending: `\u25CB` (white circle) in dimmed
    - Indentation: each todo item indented by 2 spaces (`"  "` prefix)
    - Header: `"Tasks ({completed}/{total})"` in bold dimmed (keep existing but make bold)
    - Completed items: dimmed text with strikethrough (keep existing)
    - In-progress items: show `activeForm` text (keep existing) but with brighter styling (not dimmed)
    - Add vertical tree lines: prefix each item with `\u2502 ` (box drawing vertical) in dimmed, last item with `\u2514 ` (box drawing up and right) for tree aesthetics

    **Update MessageBubble.tsx** -- Optional diff enhancement:
    - Import InlineDiff
    - In the `tool_call` case, after the InlineToolCall rendering, check if `message.output` exists and contains diff-like content
    - Simple heuristic: if output has lines starting with `+ ` and `- ` within the first 10 lines, render with InlineDiff
    - For now, this is an additive enhancement. If no diff content detected, the output renders as before (truncated dimmed text)
    - Export InlineDiff for potential use by other components

    **Update gateway-client.ts** -- No structural changes. Verify the ChatMessage types support the data needed for inline rendering. The existing `ToolCallMessage` type already has `toolName`, `input`, `output`, `status` which is sufficient.
  </action>
  <verify>
    1. `cd /Users/drew-mini/Documents/GitHub/tek && npx turbo build --filter=@tek/cli` -- builds without TypeScript errors
    2. Verify InlineDiff.tsx imports from "diff" package and uses diffLines
    3. Verify TodoPanel.tsx has updated Unicode icons and tree-style indentation
    4. Verify `pnpm ls diff --filter @tek/cli` shows diff package is installed
    5. Run `cd /Users/drew-mini/Documents/GitHub/tek && node -e "const {diffLines} = require('diff'); console.log(diffLines('a\nb\n', 'a\nc\n').length)"` to verify diff package works
  </verify>
  <done>
    InlineDiff component renders red/green line changes with auto-collapse for large diffs. TodoPanel displays with tree-style layout and Unicode status icons matching Claude Code aesthetic. Diff rendering is wired into MessageBubble for tool call outputs that contain diff content.
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build --filter=@tek/cli` passes with zero errors
2. InlineToolCall.tsx has TOOL_ICONS with at least 6 tool type entries
3. InlineApproval.tsx handles tool, skill, and preflight approval types
4. InlineDiff.tsx uses diffLines from the diff package
5. TodoPanel.tsx uses Unicode tree-drawing characters
6. Chat.tsx renders InputBar unconditionally (always visible)
7. MessageBubble.tsx uses InlineToolCall for tool_call and bash_command cases
8. No references to ToolPanel in Chat.tsx rendering
9. `diff` package listed in packages/cli/package.json dependencies
</verification>

<success_criteria>
- Tool calls appear inline with colored icons (green triangle for bash, cyan circle for reads, blue pencil for writes)
- Approval prompts appear as bordered boxes in the conversation scroll area
- Input zone remains visible and disabled during approval (not replaced)
- File diffs render with red/green coloring when content is available
- Large diffs auto-collapse with summary count
- Todos display in tree-style with heavy checkmarks, spinners, and circles
- All approval types (tool, skill, preflight) work through the new InlineApproval component
</success_criteria>

<output>
After completion, create `.planning/phases/34-cli-chat-ux-overhaul/34-02-SUMMARY.md`
</output>
