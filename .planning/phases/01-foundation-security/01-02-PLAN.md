---
phase: 01-foundation-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/cli/package.json
  - packages/cli/tsconfig.json
  - packages/cli/src/index.ts
  - packages/cli/src/vault/index.ts
  - packages/cli/src/vault/keychain.ts
  - packages/cli/src/vault/providers.ts
  - packages/cli/src/commands/keys.ts
autonomous: true

must_haves:
  truths:
    - "User can add an API key for anthropic/openai/ollama via CLI command and it is stored in OS keychain"
    - "User can update an existing API key and the old key is overwritten in keychain"
    - "User can remove an API key and it is deleted from keychain"
    - "User can list providers showing which have keys configured"
    - "Every key add/update/remove operation is recorded in the audit log"
  artifacts:
    - path: "packages/cli/src/vault/keychain.ts"
      provides: "Thin wrapper around @napi-rs/keyring with agentspace service name"
      exports: ["keychainSet", "keychainGet", "keychainDelete"]
    - path: "packages/cli/src/vault/providers.ts"
      provides: "Provider type definition and validation, key format hints"
      exports: ["PROVIDERS", "Provider", "validateProvider"]
    - path: "packages/cli/src/vault/index.ts"
      provides: "Public vault API: addKey, getKey, removeKey, listProviders, getOrCreateAuthToken"
      exports: ["addKey", "getKey", "removeKey", "listProviders", "getOrCreateAuthToken"]
    - path: "packages/cli/src/commands/keys.ts"
      provides: "Commander subcommand: agentspace keys add|update|remove|list"
      exports: ["keysCommand"]
    - path: "packages/cli/src/index.ts"
      provides: "CLI entry point with commander program setup"
      contains: "commander"
  key_links:
    - from: "packages/cli/src/vault/keychain.ts"
      to: "@napi-rs/keyring"
      via: "Entry class for keychain operations"
      pattern: "new Entry"
    - from: "packages/cli/src/vault/index.ts"
      to: "packages/db/src/connection.ts"
      via: "recordAuditEvent for key operations"
      pattern: "recordAuditEvent"
    - from: "packages/cli/src/commands/keys.ts"
      to: "packages/cli/src/vault/index.ts"
      via: "Calls vault functions from CLI commands"
      pattern: "addKey|removeKey|listProviders"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/keys.ts"
      via: "Registers keys subcommand with commander"
      pattern: "program\\.addCommand"
---

<objective>
Build the credential vault module and CLI key management commands so users can add, update, remove, and list API keys for Anthropic, OpenAI, and Ollama providers.

Purpose: The credential vault is the security core of AgentSpace. All API keys flow through it — stored in OS keychain, accessed via CLI commands, served via the local API (Plan 03). Every operation is audit-logged.
Output: @agentspace/cli package with working `agentspace keys add|update|remove|list` commands and an underlying vault module backed by OS keychain.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credential vault module with keychain wrapper</name>
  <files>
    packages/cli/package.json
    packages/cli/tsconfig.json
    packages/cli/src/vault/keychain.ts
    packages/cli/src/vault/providers.ts
    packages/cli/src/vault/index.ts
  </files>
  <action>
    1. **@agentspace/cli package setup**:
       - package.json: name "@agentspace/cli", type: "module", bin: { "agentspace": "./dist/index.js" }. Dependencies: ink@^6.0.0, @inkjs/ui, chalk@^5.0.0, commander@^12.0.0, @napi-rs/keyring@^1.2.0, @agentspace/core (workspace:*), @agentspace/db (workspace:*). DevDependencies: @types/node.
       - tsconfig.json: extends tsconfig.base.json, include ["src"]. Add "jsx": "react-jsx", "jsxImportSource": "react" for Ink components (needed in Plan 03).

    2. **Keychain wrapper** (`src/vault/keychain.ts`):
       - Import `Entry` from `@napi-rs/keyring`
       - Constant: `SERVICE_NAME = 'agentspace'`
       - `keychainSet(account: string, password: string): void` — creates Entry and calls setPassword
       - `keychainGet(account: string): string | null` — try/catch around getPassword, return null on error (key not found throws)
       - `keychainDelete(account: string): boolean` — try/catch around deletePassword, return true if deleted, false if not found
       - Export all three functions

    3. **Provider definitions** (`src/vault/providers.ts`):
       - `PROVIDERS = ['anthropic', 'openai', 'ollama'] as const`
       - `type Provider = typeof PROVIDERS[number]`
       - `validateProvider(input: string): Provider` — throws VaultError if not in PROVIDERS list
       - `PROVIDER_KEY_PREFIXES` object mapping provider to expected key prefix for validation hints (anthropic: 'sk-ant-', openai: 'sk-', ollama: null). Used for warnings, not hard enforcement.

    4. **Public vault API** (`src/vault/index.ts`):
       - `addKey(provider: Provider, key: string): void` — calls keychainSet(`api-key:${provider}`, key), then recordAuditEvent({ event: 'key_added', provider })
       - `getKey(provider: Provider): string | null` — calls keychainGet(`api-key:${provider}`)
       - `updateKey(provider: Provider, key: string): void` — same as addKey but records 'key_updated' event. Check key exists first; throw VaultError if not.
       - `removeKey(provider: Provider): void` — calls keychainDelete, records 'key_removed' event. Throw VaultError if key doesn't exist.
       - `listProviders(): { provider: Provider; configured: boolean }[]` — checks each provider
       - `getOrCreateAuthToken(): string` — keychainGet('api-endpoint-token'), if null generate with generateAuthToken() from @agentspace/core, keychainSet, return token
       - Import recordAuditEvent from @agentspace/db for audit logging on every key operation

    All functions should use the createLogger from @agentspace/core for debug/info output.
  </action>
  <verify>
    ```
    pnpm --filter @agentspace/cli build
    ```
    TypeScript compilation succeeds. Vault module compiles without errors.
  </verify>
  <done>Vault module compiles. Exports addKey, getKey, updateKey, removeKey, listProviders, getOrCreateAuthToken. Keychain wrapper uses @napi-rs/keyring Entry class. All key operations record audit events via @agentspace/db.</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI entry point with keys subcommand</name>
  <files>
    packages/cli/src/commands/keys.ts
    packages/cli/src/index.ts
  </files>
  <action>
    1. **Keys command** (`src/commands/keys.ts`):
       - Create a commander Command named 'keys' with description 'Manage API keys for LLM providers'
       - Subcommands:

       **keys add &lt;provider&gt;**:
         - Option: `--key <value>` (optional, for non-interactive use)
         - If --key not provided: prompt for key using process.stdin with echo disabled (readline with terminal: false for hidden input, or use a simple masked prompt). Print "Enter API key for {provider}: " and read from stdin.
         - Validate provider using validateProvider()
         - If key prefix doesn't match PROVIDER_KEY_PREFIXES, print warning (chalk.yellow) but proceed
         - Call addKey(provider, key)
         - Print success: chalk.green("API key for {provider} stored in keychain")

       **keys update &lt;provider&gt;**:
         - Same --key option and interactive fallback as add
         - Call updateKey(provider, key)
         - Print success message

       **keys remove &lt;provider&gt;**:
         - No confirmation prompt needed (keep it simple; user typed the command intentionally)
         - Call removeKey(provider)
         - Print: chalk.green("API key for {provider} removed from keychain")

       **keys list**:
         - Call listProviders()
         - Print table-like output showing each provider and whether it's configured (chalk.green checkmark or chalk.red x)

       All subcommands: wrap in try/catch, print errors with chalk.red, exit with code 1 on error.

    2. **CLI entry point** (`src/index.ts`):
       - `#!/usr/bin/env node` at top
       - Import { Command } from 'commander'
       - Create program: name('agentspace'), version from package.json or hardcode '0.1.0', description
       - Register keysCommand: `program.addCommand(keysCommand)`
       - `program.parse()` at the end
       - Note: init and config commands will be added in Plan 03

    3. Add to root package.json scripts or verify turbo pipeline includes the cli package in build.
  </action>
  <verify>
    ```
    pnpm build
    # Test the CLI binary works
    node packages/cli/dist/index.js --help
    node packages/cli/dist/index.js keys --help
    node packages/cli/dist/index.js keys list
    ```
    All three commands should produce output. `keys list` should show all three providers as not configured (unless keys exist from prior usage). The `--help` output should show `keys` subcommand with add/update/remove/list.
  </verify>
  <done>CLI entry point works. `agentspace --help` shows program info with keys subcommand. `agentspace keys list` shows provider status. `agentspace keys add anthropic --key sk-ant-test` stores the key in OS keychain and logs an audit event. `agentspace keys remove anthropic` deletes the key.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds (all three packages: core, db, cli)
2. `node packages/cli/dist/index.js keys list` shows three providers
3. `node packages/cli/dist/index.js keys add anthropic --key test-key-123` stores key and prints success
4. `node packages/cli/dist/index.js keys list` now shows anthropic as configured
5. `node packages/cli/dist/index.js keys remove anthropic` removes key and prints success
6. `node packages/cli/dist/index.js keys list` shows anthropic as not configured again
7. Audit log in ~/.config/agentspace/agentspace.db contains key_added and key_removed events
</verification>

<success_criteria>
- User can manage API keys (add/update/remove/list) for anthropic, openai, ollama via CLI
- Keys are stored in OS keychain via @napi-rs/keyring, not in config files
- Every key operation creates an audit log entry in SQLite
- CLI supports both `--key` flag (scriptable) and interactive input (masked)
- Auth token for API endpoint is generated and stored in keychain via getOrCreateAuthToken()
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-02-SUMMARY.md`
</output>
