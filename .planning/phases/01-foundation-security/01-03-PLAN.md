---
phase: 01-foundation-security
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - packages/core/src/config/security.ts
  - packages/gateway/package.json
  - packages/gateway/tsconfig.json
  - packages/gateway/src/index.ts
  - packages/gateway/src/key-server/index.ts
  - packages/gateway/src/key-server/server.ts
  - packages/gateway/src/key-server/routes.ts
  - packages/gateway/src/key-server/auth.ts
  - packages/cli/src/commands/init.ts
  - packages/cli/src/commands/config.ts
  - packages/cli/src/commands/audit.ts
  - packages/cli/src/components/Onboarding.tsx
  - packages/cli/src/index.ts
autonomous: false

must_haves:
  truths:
    - "User can choose Full Control or Limited Control mode during first-run onboarding and the choice persists across restarts"
    - "Limited Control mode validates file paths against the workspace directory, blocking access outside it"
    - "Local API endpoint at 127.0.0.1 serves API keys only to requests with a valid bearer token"
    - "Every key access through the API is recorded in the audit log"
    - "Unauthenticated requests to the API endpoint are rejected with 401"
    - "User can view audit log entries via CLI command"
  artifacts:
    - path: "packages/core/src/config/security.ts"
      provides: "isPathWithinWorkspace() for Limited Control enforcement, permission grant types"
      exports: ["isPathWithinWorkspace"]
    - path: "packages/gateway/src/key-server/server.ts"
      provides: "Fastify server bound to 127.0.0.1 with bearer auth"
      exports: ["createKeyServer"]
    - path: "packages/gateway/src/key-server/routes.ts"
      provides: "GET /keys/:provider route, GET /health route"
      contains: "keys/:provider"
    - path: "packages/cli/src/components/Onboarding.tsx"
      provides: "Ink-based onboarding wizard with mode selection"
      contains: "Onboarding"
    - path: "packages/cli/src/commands/init.ts"
      provides: "agentspace init command triggering onboarding"
      exports: ["initCommand"]
    - path: "packages/cli/src/commands/audit.ts"
      provides: "agentspace audit command to view audit log"
      exports: ["auditCommand"]
  key_links:
    - from: "packages/gateway/src/key-server/routes.ts"
      to: "packages/cli/src/vault/index.ts"
      via: "getKey() to retrieve keys from keychain"
      pattern: "getKey"
    - from: "packages/gateway/src/key-server/routes.ts"
      to: "packages/db/src/connection.ts"
      via: "recordAuditEvent for key access logging"
      pattern: "recordAuditEvent"
    - from: "packages/gateway/src/key-server/auth.ts"
      to: "packages/cli/src/vault/index.ts"
      via: "getOrCreateAuthToken for bearer validation"
      pattern: "getOrCreateAuthToken"
    - from: "packages/cli/src/commands/init.ts"
      to: "packages/core/src/config/loader.ts"
      via: "saveConfig after onboarding completes"
      pattern: "saveConfig"
---

<objective>
Implement security mode enforcement, the local key-serving API endpoint, and the onboarding wizard that ties the entire Phase 1 together.

Purpose: This plan completes the Phase 1 user-facing experience. After this plan, a user can run `agentspace init` to set up their security mode, `agentspace keys add` to store keys, and external applications can retrieve keys from the local API endpoint — all with audit logging and authentication.
Output: @agentspace/gateway with key-serving API, security mode enforcement in core, onboarding wizard in CLI, and config/audit CLI commands.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-security/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Security mode enforcement and local API endpoint</name>
  <files>
    packages/core/src/config/security.ts
    packages/core/src/index.ts
    packages/gateway/package.json
    packages/gateway/tsconfig.json
    packages/gateway/src/index.ts
    packages/gateway/src/key-server/index.ts
    packages/gateway/src/key-server/server.ts
    packages/gateway/src/key-server/routes.ts
    packages/gateway/src/key-server/auth.ts
  </files>
  <action>
    **Part A: Security mode enforcement in @agentspace/core**

    1. Create `packages/core/src/config/security.ts`:
       - `isPathWithinWorkspace(candidatePath: string, workspaceDir: string): boolean`
         - Resolve candidatePath with path.resolve()
         - Resolve workspaceDir with path.resolve()
         - Check resolvedCandidate starts with resolvedWorkspace + path.sep (or equals resolvedWorkspace)
         - Also check realpathSync for symlink escape prevention (try/catch — if file doesn't exist yet, allow if resolved path was OK)
         - Return boolean
       - Export from core/src/index.ts

    **Part B: @agentspace/gateway package with key-serving API**

    2. **Gateway package setup**:
       - package.json: name "@agentspace/gateway", type: "module". Dependencies: fastify@^5.0.0, @fastify/bearer-auth@^10.1.0, @agentspace/core (workspace:*), @agentspace/db (workspace:*), @agentspace/cli (workspace:*). DevDependencies: @types/node.
       - tsconfig.json: extends tsconfig.base.json, include ["src"]

    3. **Auth module** (`src/key-server/auth.ts`):
       - `getAuthKeys(): Set<string>` — calls getOrCreateAuthToken() from @agentspace/cli vault, returns `new Set([token])`
       - Export function for use in server setup

    4. **Server factory** (`src/key-server/server.ts`):
       - `createKeyServer(opts?: { port?: number }): Promise<FastifyInstance>`
       - Create Fastify instance with logger configured to REDACT Authorization header in serializers (see research pitfall 3)
       - Register @fastify/bearer-auth with keys from getAuthKeys()
       - Register routes from routes.ts
       - Bind to host: '127.0.0.1', port from opts or loadConfig().apiEndpoint.port or default 3271
       - If EADDRINUSE: try next 10 ports, log which port was bound
       - After successful listen: write runtime.json to RUNTIME_PATH with { pid: process.pid, port: actualPort, startedAt: ISO timestamp }
       - On process exit (SIGTERM/SIGINT): clean up runtime.json file
       - Return the fastify instance

    5. **Routes** (`src/key-server/routes.ts`):
       - `GET /health` — returns { status: 'ok', uptime: process.uptime() }. No auth required for this route (register before bearer-auth, or use addHook to skip auth).

         Actually, @fastify/bearer-auth applies globally. For /health to be unauthenticated, either: (a) register health route in a separate plugin scope without bearer-auth, or (b) add a custom errorHandler to bearer-auth that skips /health. Simplest: register bearer-auth in a plugin scope that only covers /keys/* routes. Do that.

       - `GET /keys/:provider` — validate provider param (use validateProvider from cli/vault). Call getKey(provider). If null, return 404. Otherwise, call recordAuditEvent({ event: 'key_accessed', provider, sourceIp: request.ip }). Return { provider, key }.

    6. **Barrel exports** (`src/key-server/index.ts` and `src/index.ts`): Export createKeyServer.

    Note on circular dependency: gateway depends on cli for vault functions. If this creates issues, consider moving the vault module to core or creating a separate @agentspace/vault package. For now, the dependency is fine since gateway only imports vault functions, not CLI UI.
  </action>
  <verify>
    ```
    pnpm build
    # Start the key server in background
    node packages/gateway/dist/index.js &
    SERVER_PID=$!
    sleep 2

    # Test unauthenticated request is rejected
    curl -s http://127.0.0.1:3271/keys/anthropic
    # Should return 401

    # Test health endpoint
    curl -s http://127.0.0.1:3271/health
    # Should return {"status":"ok",...}

    # Read auth token from runtime or keychain for authenticated test
    # (Manual verification - token is in keychain)

    kill $SERVER_PID
    ```
    Build succeeds for all 4 packages. Server binds to 127.0.0.1. Unauthenticated requests rejected.
  </verify>
  <done>Gateway key-server binds to 127.0.0.1 only. Bearer auth rejects unauthenticated requests with 401. GET /keys/:provider returns key from vault and logs to audit. GET /health works without auth. Runtime.json written with PID and port. Security mode enforcement function isPathWithinWorkspace() handles path.resolve + realpathSync for symlink detection.</done>
</task>

<task type="auto">
  <name>Task 2: Onboarding wizard and CLI config/audit commands</name>
  <files>
    packages/cli/src/commands/init.ts
    packages/cli/src/commands/config.ts
    packages/cli/src/commands/audit.ts
    packages/cli/src/components/Onboarding.tsx
    packages/cli/src/index.ts
  </files>
  <action>
    1. **Onboarding component** (`src/components/Onboarding.tsx`):
       - Multi-step Ink wizard with states: 'welcome' -> 'mode' -> 'workspace' (if limited-control) -> 'keys' -> 'summary' -> 'done'
       - **welcome**: Display "Welcome to AgentSpace" in bold. Brief explanation of what it does (2-3 lines). Press enter to continue.
       - **mode**: Use Ink Select component:
         - "Full Control — OS-level access with explicit permission grants per capability"
         - "Limited Control — Agent restricted to a designated workspace directory"
       - **workspace** (only if limited-control selected): Use Ink TextInput for workspace directory path. Validate directory exists (or offer to create it). Show resolved path.
       - **keys**: Ask "Would you like to add an API key now?" with ConfirmInput. If yes, use Select to pick provider, then TextInput (masked) for key. Allow adding multiple keys in a loop. "Add another?" with ConfirmInput.
       - **summary**: Show configured settings:
         - Security mode: {mode}
         - Workspace: {dir} (if limited-control)
         - API keys: {list of configured providers}
         - API endpoint: will be available at 127.0.0.1:{port}
       - **done**: Call saveConfig() with the assembled AppConfig (securityMode, workspaceDir, onboardingComplete: true, createdAt: new Date().toISOString()). Generate auth token via getOrCreateAuthToken(). Print "Setup complete!" in green.
       - Accept an `onComplete` callback prop so the init command can handle post-wizard logic.

    2. **Init command** (`src/commands/init.ts`):
       - Commander command 'init' with description 'Set up AgentSpace for first use'
       - Check configExists() first:
         - If config exists: print "AgentSpace is already configured." Ask "Re-run setup? (existing API keys will be preserved)" — use a simple y/n readline prompt (not Ink, to keep it simple). If no, exit.
       - Render the Onboarding component using Ink's render()
       - Wait for completion (use a promise resolved by onComplete callback)

    3. **Config command** (`src/commands/config.ts`):
       - Commander command 'config' with subcommands:
       - `config show`: Load and display current config (security mode, workspace dir, API endpoint port, onboarding status)
       - `config set mode <mode>`: Change security mode. Validate mode. If switching to limited-control, require workspace dir (prompt or --workspace flag). Save config. Record 'mode_changed' audit event.
       - `config rotate-token`: Generate new auth token, store in keychain (overwrites old one). Print warning that existing applications using the old token will need the new one. Record audit event.

    4. **Audit command** (`src/commands/audit.ts`):
       - Commander command 'audit' with description 'View audit log'
       - Options: --limit <n> (default 20), --provider <name>, --json (output as JSON instead of table)
       - Call getAuditEvents() from @agentspace/db with the options
       - Format as a simple table (timestamp | event | provider | source) using chalk for coloring. Or JSON output if --json flag.

    5. **Update CLI entry point** (`src/index.ts`):
       - Import and register initCommand, configCommand, auditCommand with program.addCommand()
       - Add a default action: if no command specified, check if config exists. If not, suggest running `agentspace init`.
  </action>
  <verify>
    ```
    pnpm build
    node packages/cli/dist/index.js --help
    # Should show: keys, init, config, audit commands

    node packages/cli/dist/index.js config show
    # Should show current config or indicate not configured

    node packages/cli/dist/index.js audit --limit 5
    # Should show recent audit events (or empty if none)
    ```
    All commands work. Onboarding wizard renders in terminal (requires interactive terminal for full test).
  </verify>
  <done>Onboarding wizard walks through mode selection, optional workspace directory, and optional key setup. Config persists to ~/.config/agentspace/config.json. `agentspace config show` displays settings. `agentspace config set mode` allows mode switching. `agentspace audit` displays audit log. CLI entry point registers all commands.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 end-to-end flow</name>
  <files>packages/cli/dist/index.js</files>
  <action>
    Human verification of the complete Phase 1 end-to-end flow. All code was built in Tasks 1 and 2. This checkpoint verifies the integrated experience works correctly.

    What was built: Complete Phase 1 foundation — monorepo scaffold, credential vault with OS keychain, CLI key management, security mode onboarding, local key-serving API, and audit logging.

    Steps to verify:
    1. From the project root, run `pnpm build` — all 4 packages should compile
    2. Run `node packages/cli/dist/index.js init` — complete the onboarding wizard (choose a security mode, optionally add a test key)
    3. Run `node packages/cli/dist/index.js keys add anthropic --key test-key-for-verification` — should succeed
    4. Run `node packages/cli/dist/index.js keys list` — should show anthropic as configured
    5. Start the key server: `node packages/gateway/dist/index.js` (in a separate terminal or background)
    6. Test unauthenticated access: `curl http://127.0.0.1:3271/keys/anthropic` — should return 401
    7. Test health: `curl http://127.0.0.1:3271/health` — should return status ok
    8. Run `node packages/cli/dist/index.js audit` — should show key_added event from step 3
    9. Run `node packages/cli/dist/index.js config show` — should show security mode and onboarding complete
    10. Clean up: `node packages/cli/dist/index.js keys remove anthropic`
  </action>
  <verify>User manually runs all 10 steps and confirms each one passes.</verify>
  <done>All 10 verification steps pass. Type "approved" or describe any issues encountered.</done>
</task>

</tasks>

<verification>
1. `pnpm build` compiles all 4 packages (core, db, cli, gateway)
2. `agentspace init` runs onboarding wizard — mode persists in config.json
3. `agentspace keys add/update/remove/list` works for all three providers
4. Key server binds to 127.0.0.1, rejects unauthenticated requests, serves keys with valid bearer token
5. Audit log records key_added, key_removed, key_accessed, mode_changed events
6. `agentspace config show` displays current settings
7. `agentspace audit` displays formatted audit log
8. isPathWithinWorkspace correctly validates paths (including symlink detection)
</verification>

<success_criteria>
- User completes first-run onboarding choosing a security mode (Full Control or Limited Control)
- Security mode persists across restarts (stored in ~/.config/agentspace/config.json)
- Limited Control mode has path enforcement function ready (isPathWithinWorkspace)
- Local API endpoint at 127.0.0.1 serves keys only to authenticated (bearer token) requests
- All key access events are logged in SQLite audit log
- CLI provides init, keys, config, and audit commands
- Only authenticated access is possible — no unauthenticated inputs accepted
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-03-SUMMARY.md`
</output>
