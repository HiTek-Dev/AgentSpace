---
phase: 01-foundation-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - turbo.json
  - tsconfig.base.json
  - biome.json
  - .gitignore
  - packages/core/package.json
  - packages/core/tsconfig.json
  - packages/core/src/index.ts
  - packages/core/src/config/index.ts
  - packages/core/src/config/schema.ts
  - packages/core/src/config/loader.ts
  - packages/core/src/config/types.ts
  - packages/core/src/crypto/index.ts
  - packages/core/src/crypto/tokens.ts
  - packages/core/src/errors.ts
  - packages/core/src/logger.ts
  - packages/db/package.json
  - packages/db/tsconfig.json
  - packages/db/drizzle.config.ts
  - packages/db/src/index.ts
  - packages/db/src/connection.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/schema/audit-log.ts
autonomous: true

must_haves:
  truths:
    - "Monorepo builds successfully with `pnpm build` from root"
    - "Core package exports config loader, schema validation, token generation, and error types"
    - "DB package exports audit log schema and a connection factory that creates/opens SQLite at ~/.config/agentspace/agentspace.db"
    - "TypeScript compilation succeeds with strict mode across all packages"
  artifacts:
    - path: "packages/core/src/config/schema.ts"
      provides: "Zod schemas for AppConfig, SecurityMode, ApiEndpointConfig"
      contains: "securityMode"
    - path: "packages/core/src/config/loader.ts"
      provides: "loadConfig(), saveConfig() functions for ~/.config/agentspace/config.json"
      exports: ["loadConfig", "saveConfig"]
    - path: "packages/core/src/crypto/tokens.ts"
      provides: "generateAuthToken(), getOrCreateAuthToken() using keychain"
      exports: ["generateAuthToken", "getOrCreateAuthToken"]
    - path: "packages/db/src/schema/audit-log.ts"
      provides: "Drizzle schema for audit_log table"
      contains: "auditLog"
    - path: "packages/db/src/connection.ts"
      provides: "getDb() factory returning Drizzle instance"
      exports: ["getDb"]
  key_links:
    - from: "packages/core/src/config/loader.ts"
      to: "packages/core/src/config/schema.ts"
      via: "Zod parse for config validation"
      pattern: "AppConfigSchema\\.parse"
    - from: "packages/db/src/connection.ts"
      to: "packages/db/src/schema/audit-log.ts"
      via: "Schema passed to drizzle()"
      pattern: "drizzle.*schema"
---

<objective>
Scaffold the AgentSpace monorepo and build the two foundational packages (@agentspace/core and @agentspace/db) that all subsequent work depends on.

Purpose: Every other plan in Phase 1 imports types, config utilities, and database connections from these packages. This plan creates the project infrastructure and shared foundations.
Output: A buildable Turborepo monorepo with core config/crypto/types and a database package with audit log schema.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold monorepo and create @agentspace/core package</name>
  <files>
    package.json
    pnpm-workspace.yaml
    turbo.json
    tsconfig.base.json
    biome.json
    .gitignore
    packages/core/package.json
    packages/core/tsconfig.json
    packages/core/src/index.ts
    packages/core/src/config/index.ts
    packages/core/src/config/schema.ts
    packages/core/src/config/loader.ts
    packages/core/src/config/types.ts
    packages/core/src/crypto/index.ts
    packages/core/src/crypto/tokens.ts
    packages/core/src/errors.ts
    packages/core/src/logger.ts
  </files>
  <action>
    Create the monorepo scaffold:

    1. **Root package.json**: name "agentspace", private: true, "packageManager": "pnpm@9.15.0" (or latest 9.x), scripts for build/lint/test delegating to turbo. engines: { node: ">=22" }.

    2. **pnpm-workspace.yaml**: packages: ["packages/*", "apps/*"]

    3. **turbo.json**: Pipeline for build (dependsOn: ["^build"]), lint, test, dev. Use Turborepo 2.x config format.

    4. **tsconfig.base.json**: Shared TypeScript config. strict: true, target: "ES2024", module: "NodeNext", moduleResolution: "NodeNext", declaration: true, declarationMap: true, sourceMap: true, outDir: "dist", rootDir: "src", skipLibCheck: true.

    5. **biome.json**: Standard Biome config. Formatter: indent with tabs, line width 100. Linter: recommended rules. Organize imports enabled.

    6. **.gitignore**: node_modules, dist, .turbo, *.tsbuildinfo, .env, .DS_Store

    7. **@agentspace/core package**:
       - package.json: name "@agentspace/core", type: "module", main/types pointing to dist, scripts for build (tsc), dependencies: zod@^4.0.0. Note: @napi-rs/keyring goes in cli package, not core.
       - tsconfig.json: extends tsconfig.base.json, include ["src"]

    8. **Core modules**:
       - `src/config/schema.ts`: Define Zod schemas:
         - `SecurityMode = z.enum(['full-control', 'limited-control'])`
         - `ApiEndpointConfig = z.object({ port: z.number().default(3271), host: z.literal('127.0.0.1').default('127.0.0.1') })`
         - `AppConfigSchema = z.object({ securityMode: SecurityMode, workspaceDir: z.string().optional(), apiEndpoint: ApiEndpointConfig.default({}), onboardingComplete: z.boolean().default(false), createdAt: z.string().datetime() })`
         - Export type `AppConfig = z.infer<typeof AppConfigSchema>`

       - `src/config/loader.ts`: Functions to read/write config:
         - `CONFIG_DIR = join(homedir(), '.config', 'agentspace')`
         - `CONFIG_PATH = join(CONFIG_DIR, 'config.json')`
         - `loadConfig(): AppConfig | null` — reads file, parses JSON, validates with Zod. Returns null if file doesn't exist. Throws on invalid schema.
         - `saveConfig(config: AppConfig): void` — mkdirSync(CONFIG_DIR, recursive), writeFileSync with JSON.stringify(config, null, 2)
         - `configExists(): boolean` — checks if CONFIG_PATH exists

       - `src/config/types.ts`: Re-export types from schema. Add `type SecurityMode = z.infer<typeof SecurityModeSchema>`. Add constants: `CONFIG_DIR`, `DB_PATH = join(CONFIG_DIR, 'agentspace.db')`, `RUNTIME_PATH = join(CONFIG_DIR, 'runtime.json')`.

       - `src/crypto/tokens.ts`:
         - `generateAuthToken(): string` — `randomBytes(32).toString('hex')`
         - These are pure utility functions. The keychain storage for the auth token will be in the CLI package vault module.

       - `src/errors.ts`: Custom error classes: `AgentSpaceError extends Error` (with code field), `ConfigError`, `VaultError`, `AuthError`.

       - `src/logger.ts`: Simple structured logger. Export `createLogger(name: string)` that returns an object with info/warn/error methods writing to stderr with ISO timestamp, name prefix, and level. Keep it simple — no library dependency.

       - `src/index.ts`: Barrel export everything from config, crypto, errors, logger.

    Install root dev dependencies:
    ```
    pnpm add -Dw turbo typescript @types/node vitest @biomejs/biome tsx
    ```

    Install core dependencies:
    ```
    pnpm --filter @agentspace/core add zod
    ```
  </action>
  <verify>
    Run from project root:
    ```
    pnpm install
    pnpm --filter @agentspace/core build
    ```
    TypeScript compilation must succeed with no errors. Verify dist/ directory contains compiled JS + declarations.
  </verify>
  <done>Core package builds successfully. Exports loadConfig, saveConfig, configExists, AppConfigSchema, SecurityMode, generateAuthToken, AgentSpaceError and subtypes, createLogger. All types are strict TypeScript with no `any`.</done>
</task>

<task type="auto">
  <name>Task 2: Create @agentspace/db package with audit log schema</name>
  <files>
    packages/db/package.json
    packages/db/tsconfig.json
    packages/db/drizzle.config.ts
    packages/db/src/index.ts
    packages/db/src/connection.ts
    packages/db/src/schema/index.ts
    packages/db/src/schema/audit-log.ts
  </files>
  <action>
    1. **@agentspace/db package**:
       - package.json: name "@agentspace/db", type: "module", dependencies: drizzle-orm@^0.45.0, better-sqlite3@^11.0.0. devDependencies: drizzle-kit, @types/better-sqlite3. Scripts: build (tsc), db:generate (drizzle-kit generate), db:migrate (drizzle-kit migrate).
       - tsconfig.json: extends tsconfig.base.json, include ["src"]

    2. **Schema** (`src/schema/audit-log.ts`):
       ```
       import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';

       export const auditLog = sqliteTable('audit_log', {
         id: integer('id').primaryKey({ autoIncrement: true }),
         timestamp: text('timestamp').notNull(),        // ISO 8601
         event: text('event').notNull(),                 // key_accessed, key_added, key_removed, key_updated, mode_changed, auth_failed
         provider: text('provider'),                     // anthropic, openai, ollama
         sourceIp: text('source_ip'),
         sourceApp: text('source_app'),
         details: text('details'),                       // JSON string for extra context
       });
       ```
       - `src/schema/index.ts`: Re-export auditLog.

    3. **Connection factory** (`src/connection.ts`):
       - Import `DB_PATH` from @agentspace/core (config/types)
       - `getDb()`: Creates SQLite connection to DB_PATH using better-sqlite3. Enables WAL mode (`db.pragma('journal_mode = WAL')`). Returns drizzle ORM instance wrapping the connection with the audit log schema.
       - Ensure CONFIG_DIR exists (mkdirSync recursive) before opening DB.
       - Add `recordAuditEvent(event: AuditEvent)` function that inserts into audit_log table. AuditEvent type: `{ event: string, provider?: string, sourceIp?: string, sourceApp?: string, details?: Record<string, unknown> }`. The details field is JSON.stringify'd before insert.
       - Add `getAuditEvents(opts?: { limit?: number, provider?: string })` function for querying.

    4. **Barrel export** (`src/index.ts`): Export schema, getDb, recordAuditEvent, getAuditEvents, AuditEvent type.

    5. **drizzle.config.ts**: Configure drizzle-kit for SQLite with the schema path and out directory for migrations.

    6. Add @agentspace/core as a workspace dependency in db's package.json: `"@agentspace/core": "workspace:*"`
  </action>
  <verify>
    ```
    pnpm --filter @agentspace/db build
    pnpm build  # Full monorepo build via turbo
    ```
    Both must succeed. Verify that @agentspace/db correctly resolves the @agentspace/core dependency (DB_PATH import).
  </verify>
  <done>DB package builds. Exports auditLog schema, getDb() connection factory, recordAuditEvent() and getAuditEvents() functions. Drizzle config is set up for migration generation. Full `pnpm build` from root succeeds with both packages.</done>
</task>

</tasks>

<verification>
1. `pnpm install` completes without errors
2. `pnpm build` from root compiles both packages via Turborepo
3. `pnpm --filter @agentspace/core build` produces dist/ with .js and .d.ts files
4. `pnpm --filter @agentspace/db build` produces dist/ with .js and .d.ts files
5. No TypeScript errors in strict mode
6. Biome lint passes: `pnpm biome check .`
</verification>

<success_criteria>
- Monorepo structure matches research recommendation (packages/core, packages/db, root tooling)
- Core package exports config schema (Zod), config loader, auth token generation, error types, and logger
- DB package exports audit log schema, connection factory, and event recording functions
- Both packages compile to ESM with TypeScript declarations
- Turborepo correctly handles build order (core before db)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-01-SUMMARY.md`
</output>
