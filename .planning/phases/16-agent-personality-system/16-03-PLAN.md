---
phase: 16-agent-personality-system
plan: 03
type: execute
wave: 2
depends_on: ["16-01", "16-02"]
files_modified:
  - packages/db/src/memory/migration.ts
  - packages/db/src/memory/soul-manager.ts
  - packages/db/src/memory/index.ts
  - packages/gateway/src/memory/memory-manager.ts
  - packages/gateway/src/context/assembler.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Migration splits existing SOUL.md into multi-file structure with backup"
    - "Migration is idempotent (marker file prevents re-runs)"
    - "Context assembler loads all identity files into system prompt"
    - "Token budget warning logged when identity files exceed 3000 tokens"
    - "Existing single-file SOUL.md users are not broken by upgrade"
  artifacts:
    - path: "packages/db/src/memory/migration.ts"
      provides: "migrateToMultiFile() with backup and marker"
      exports: ["migrateToMultiFile"]
    - path: "packages/gateway/src/memory/memory-manager.ts"
      provides: "Expanded getMemoryContext() returning all 5 identity fields"
      contains: "identity"
    - path: "packages/gateway/src/context/assembler.ts"
      provides: "System prompt with all identity sections and token budget warning"
      contains: "Your Presentation"
  key_links:
    - from: "packages/gateway/src/memory/memory-manager.ts"
      to: "packages/db/src/memory/identity-manager.ts"
      via: "import loadIdentity, loadStyle, loadUser, loadAgentsConfig"
      pattern: "loadIdentity.*loadStyle.*loadUser"
    - from: "packages/gateway/src/context/assembler.ts"
      to: "packages/gateway/src/memory/memory-manager.ts"
      via: "memoryCtx.identity, memoryCtx.style, memoryCtx.user"
      pattern: "memoryCtx\\.(identity|style|user)"
    - from: "packages/db/src/memory/migration.ts"
      to: "packages/db/src/memory/soul-manager.ts"
      via: "loadSoul() to read existing content"
      pattern: "loadSoul"
---

<objective>
Create migration from single-file to multi-file identity, expand the gateway's MemoryManager and context assembler to load all identity files into the system prompt with token budget enforcement.

Purpose: Connects the identity file infrastructure (Plan 01) to the LLM context pipeline, ensuring the agent's personality is fully represented in every conversation. Migration preserves existing user customizations.
Output: migration.ts, expanded MemoryManager, expanded assembler with all identity sections.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-agent-personality-system/16-01-SUMMARY.md
@.planning/phases/16-agent-personality-system/16-02-SUMMARY.md
@packages/db/src/memory/soul-manager.ts
@packages/gateway/src/memory/memory-manager.ts
@packages/gateway/src/context/assembler.ts
@packages/gateway/src/context/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration.ts and update soul-manager.ts</name>
  <files>
    packages/db/src/memory/migration.ts
    packages/db/src/memory/soul-manager.ts
    packages/db/src/memory/index.ts
  </files>
  <action>
    Create `packages/db/src/memory/migration.ts`:

    The migration function:
    1. Checks for marker file `~/.config/tek/memory/.v2-migrated`. If exists, return early (idempotent).
    2. Loads existing SOUL.md via `loadSoul()`.
    3. If no soul content exists, just write the marker and return (fresh install, templates handle seeding).
    4. Creates backup: copy SOUL.md to `SOUL.md.backup-{timestamp}`.
    5. Extracts sections from existing SOUL.md by `## ` headers:
       - Content under `## Communication Style` -> write to STYLE.md (only if STYLE.md doesn't already exist)
       - Content under `## Learned Preferences` -> keep in SOUL.md (do NOT move)
       - Everything else stays in SOUL.md
    6. Does NOT overwrite the existing SOUL.md with the new expanded template (preserves user customizations). The expanded template only applies to fresh installs via ensureMemoryFile().
    7. Writes the marker file with ISO timestamp.
    8. Returns `{ migrated: boolean, backup?: string }`.

    Key principle: Migration is CONSERVATIVE. It only creates STYLE.md from extracted content. It does NOT touch IDENTITY.md, USER.md, or AGENTS.md (those get seeded via ensureMemoryFile on next load). It does NOT modify the soul content itself.

    Update `soul-manager.ts`:
    - Add optional `agentId` parameter to `loadSoul()` signature: `loadSoul(agentId?: string): string`
    - When agentId is provided and not "default", use `resolveIdentityFile(agentId, "SOUL.md")` instead of the global path
    - When agentId is undefined or "default", keep existing behavior (global SOUL_PATH)
    - Import `resolveIdentityFile` from `./agent-resolver.js`

    Update `packages/db/src/memory/index.ts` to export:
    ```typescript
    export { migrateToMultiFile } from "./migration.js";
    ```
  </action>
  <verify>Run `npx tsc --noEmit` from packages/db/. Verify migration.ts exports migrateToMultiFile. Verify loadSoul signature accepts optional agentId.</verify>
  <done>migration.ts creates backup, extracts Communication Style to STYLE.md, writes marker. loadSoul() accepts optional agentId for per-agent resolution. Both exported from @tek/db.</done>
</task>

<task type="auto">
  <name>Task 2: Expand MemoryManager and context assembler</name>
  <files>
    packages/gateway/src/memory/memory-manager.ts
    packages/gateway/src/context/assembler.ts
  </files>
  <action>
    Update `packages/gateway/src/memory/memory-manager.ts`:

    1. Import new loaders: `import { loadSoul, loadLongTermMemory, loadRecentLogs, searchMemories, embedAndStore, appendDailyLog, loadIdentity, loadStyle, loadUser, loadAgentsConfig } from "@tek/db";`
    2. Expand the `getMemoryContext()` return type to include all identity files:
       ```typescript
       getMemoryContext(agentId?: string): {
         soul: string;
         identity: string;
         style: string;
         user: string;
         agents: string;
         longTermMemory: string;
         recentLogs: string;
       }
       ```
    3. Implementation calls each loader:
       ```typescript
       return {
         soul: loadSoul(agentId),
         identity: loadIdentity(agentId),
         style: loadStyle(agentId),
         user: loadUser(),
         agents: loadAgentsConfig(),
         longTermMemory: loadLongTermMemory(),
         recentLogs: loadRecentLogs(),
       };
       ```

    Update `packages/gateway/src/context/assembler.ts`:

    1. Expand the `systemParts` array to include all identity sections:
       ```typescript
       const systemParts = [
         userSystemPrompt,
         memoryCtx.soul     ? `\n\n# Your Identity\n${memoryCtx.soul}` : "",
         memoryCtx.identity ? `\n\n# Your Presentation\n${memoryCtx.identity}` : "",
         memoryCtx.style    ? `\n\n# Communication Style\n${memoryCtx.style}` : "",
         memoryCtx.user     ? `\n\n# About the User\n${memoryCtx.user}` : "",
         memoryCtx.agents   ? `\n\n# Agent Coordination\n${memoryCtx.agents}` : "",
         memoryCtx.longTermMemory ? `\n\n# Long-Term Memory\n${memoryCtx.longTermMemory}` : "",
         memoryCtx.recentLogs     ? `\n\n# Recent Activity\n${memoryCtx.recentLogs}` : "",
       ].filter(Boolean).join("");
       ```
    2. Add measured sections for context inspection for each new identity file:
       ```typescript
       addSection(sections, "identity", memoryCtx.identity, pricing.inputPerMTok);
       addSection(sections, "style", memoryCtx.style, pricing.inputPerMTok);
       addSection(sections, "user_context", memoryCtx.user, pricing.inputPerMTok);
       addSection(sections, "agents", memoryCtx.agents, pricing.inputPerMTok);
       ```
    3. After building sections, compute combined identity token count (soul + identity + style) and log a warning via `createLogger("assembler")` if it exceeds 3000 tokens:
       ```typescript
       const identityTokens = [memoryCtx.soul, memoryCtx.identity, memoryCtx.style]
         .reduce((sum, content) => sum + (content ? estimateTokenCount(content) : 0), 0);
       if (identityTokens > 3000) {
         logger.warn(`Identity files exceed 3000 token budget (${identityTokens} tokens). Consider trimming SOUL.md, IDENTITY.md, or STYLE.md.`);
       }
       ```
       Import `createLogger` from `@tek/core` (already imported in file).
  </action>
  <verify>Run `npx tsc --noEmit` from packages/gateway/. Verify assembler.ts has all 5 identity sections in systemParts. Verify token budget warning exists.</verify>
  <done>MemoryManager.getMemoryContext() returns all 7 fields (soul, identity, style, user, agents, longTermMemory, recentLogs). Assembler injects all identity files into system prompt with per-section measurement. Token budget warning logged at 3000+ tokens.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes from both packages/db/ and packages/gateway/
- `grep "migrateToMultiFile" packages/db/src/memory/index.ts` shows export
- `grep "identity" packages/gateway/src/context/assembler.ts` shows identity section injection
- `grep "3000" packages/gateway/src/context/assembler.ts` shows token budget check
- `grep "agentId" packages/db/src/memory/soul-manager.ts` shows optional parameter
</verification>

<success_criteria>
- Migration creates backup, extracts style content, writes marker, is idempotent
- loadSoul() accepts optional agentId for per-agent resolution
- MemoryManager returns all 7 memory/identity fields
- Assembler injects all identity files into system prompt in priority order
- Context inspection shows per-section token counts for all identity files
- Token budget warning logged when soul + identity + style > 3000 tokens
- TypeScript compiles without errors in both packages
</success_criteria>

<output>
After completion, create `.planning/phases/16-agent-personality-system/16-03-SUMMARY.md`
</output>
