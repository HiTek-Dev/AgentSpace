---
phase: 16-agent-personality-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/config/schema.ts
  - packages/db/src/memory/agent-resolver.ts
  - packages/db/src/memory/index.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "AppConfig has an optional agents section with list and defaultAgentId"
    - "Agent resolver provides cascade file resolution: agent-specific > shared > global > empty"
    - "Single-agent setups use global memory directory (backward-compatible)"
  artifacts:
    - path: "packages/core/src/config/schema.ts"
      provides: "AgentDefinitionSchema, AgentsConfigSchema added to AppConfigSchema"
      contains: "AgentsConfigSchema"
    - path: "packages/db/src/memory/agent-resolver.ts"
      provides: "resolveIdentityFile() with cascade resolution"
      exports: ["resolveIdentityFile", "resolveAgentDir", "AGENTS_DIR"]
  key_links:
    - from: "packages/db/src/memory/agent-resolver.ts"
      to: "packages/core/src/config/schema.ts"
      via: "CONFIG_DIR import for agents directory path"
      pattern: "CONFIG_DIR"
---

<objective>
Add multi-agent config schema to AppConfig and create the agent directory resolver with cascade file resolution (agent-specific > shared > global memory > empty string).

Purpose: Enables per-agent identity isolation while maintaining backward compatibility for single-agent setups.
Output: Extended AppConfigSchema with agents section, agent-resolver.ts with cascade resolution logic.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/core/src/config/schema.ts
@packages/db/src/memory/soul-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AgentsConfig to AppConfigSchema</name>
  <files>packages/core/src/config/schema.ts</files>
  <action>
    Add two new Zod schemas before the AppConfigSchema definition:

    ```typescript
    export const AgentDefinitionSchema = z.object({
      id: z.string(),
      name: z.string().optional(),
      model: z.string().optional(),
      description: z.string().optional(),
    });

    export const AgentsConfigSchema = z.object({
      list: z.array(AgentDefinitionSchema).default([]),
      defaultAgentId: z.string().default("default"),
    });
    ```

    Add to AppConfigSchema:
    ```typescript
    agents: AgentsConfigSchema.optional(),
    ```

    Export the new types:
    ```typescript
    export type AgentDefinition = z.infer<typeof AgentDefinitionSchema>;
    export type AgentsConfig = z.infer<typeof AgentsConfigSchema>;
    ```

    Do NOT modify any existing fields. The agents field is optional so existing configs remain valid.
  </action>
  <verify>Run `npx tsc --noEmit` from packages/core/ to confirm no type errors. Verify AppConfigSchema.parse({}) still works with existing configs (agents is optional).</verify>
  <done>AppConfigSchema includes optional `agents` field with AgentDefinitionSchema and AgentsConfigSchema. Existing configs parse without changes.</done>
</task>

<task type="auto">
  <name>Task 2: Create agent-resolver.ts with cascade resolution</name>
  <files>
    packages/db/src/memory/agent-resolver.ts
    packages/db/src/memory/index.ts
  </files>
  <action>
    Create `packages/db/src/memory/agent-resolver.ts`:

    ```typescript
    import { existsSync, readFileSync, mkdirSync } from "node:fs";
    import { join } from "node:path";
    import { CONFIG_DIR } from "@tek/core";

    /** Base directory for per-agent identity files */
    export const AGENTS_DIR = join(CONFIG_DIR, "agents");

    /** Shared identity files (e.g., USER.md) used across all agents */
    const SHARED_DIR = join(AGENTS_DIR, "shared");

    /** Global memory directory (backward-compatible, single-agent default) */
    const GLOBAL_MEMORY_DIR = join(CONFIG_DIR, "memory");

    /**
     * Resolve an identity file using cascade resolution:
     * 1. Agent-specific: ~/.config/tek/agents/{agentId}/{filename}
     * 2. Shared: ~/.config/tek/agents/shared/{filename}
     * 3. Global: ~/.config/tek/memory/{filename} (backward-compatible)
     * 4. Empty string (file not found anywhere)
     *
     * For single-agent setups (no agentId), skips step 1 and falls through
     * to shared/global, which means the existing memory/ directory works unchanged.
     */
    export function resolveIdentityFile(
      agentId: string | undefined,
      filename: string,
    ): string {
      // 1. Agent-specific
      if (agentId && agentId !== "default") {
        const agentPath = join(AGENTS_DIR, agentId, filename);
        if (existsSync(agentPath)) return readFileSync(agentPath, "utf-8");
      }

      // 2. Shared (for USER.md and other cross-agent files)
      const sharedPath = join(SHARED_DIR, filename);
      if (existsSync(sharedPath)) return readFileSync(sharedPath, "utf-8");

      // 3. Global memory directory (backward-compatible)
      const globalPath = join(GLOBAL_MEMORY_DIR, filename);
      if (existsSync(globalPath)) return readFileSync(globalPath, "utf-8");

      return "";
    }

    /**
     * Get the directory path for a specific agent's identity files.
     * Creates the directory if it doesn't exist (lazy creation).
     * Returns the global memory directory for the default agent.
     */
    export function resolveAgentDir(agentId?: string): string {
      if (!agentId || agentId === "default") {
        return GLOBAL_MEMORY_DIR;
      }
      const agentDir = join(AGENTS_DIR, agentId);
      if (!existsSync(agentDir)) {
        mkdirSync(agentDir, { recursive: true });
      }
      return agentDir;
    }
    ```

    Update `packages/db/src/memory/index.ts` to add exports:
    ```typescript
    export { resolveIdentityFile, resolveAgentDir, AGENTS_DIR } from "./agent-resolver.js";
    ```
  </action>
  <verify>Run `npx tsc --noEmit` from packages/db/ to confirm no type errors. Verify index.ts exports resolveIdentityFile, resolveAgentDir, AGENTS_DIR.</verify>
  <done>agent-resolver.ts exports resolveIdentityFile (cascade: agent > shared > global > empty) and resolveAgentDir (lazy directory creation). Default agent uses global memory directory for backward compatibility. All exported from @tek/db.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes from both packages/core/ and packages/db/
- `grep "agents" packages/core/src/config/schema.ts` shows the new field
- `grep -c "export function" packages/db/src/memory/agent-resolver.ts` returns 2
- `grep "agent-resolver" packages/db/src/memory/index.ts` shows re-export
</verification>

<success_criteria>
- AppConfigSchema includes optional agents field with list + defaultAgentId
- Existing configs without agents field still parse correctly
- agent-resolver.ts provides cascade resolution (agent > shared > global > empty)
- Default agent ("default" or undefined) falls through to global memory directory
- Lazy directory creation for non-default agents
- TypeScript compiles without errors in both packages
</success_criteria>

<output>
After completion, create `.planning/phases/16-agent-personality-system/16-02-SUMMARY.md`
</output>
