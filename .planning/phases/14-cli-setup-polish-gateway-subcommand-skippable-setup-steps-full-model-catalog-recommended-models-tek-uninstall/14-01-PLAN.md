---
phase: 14-cli-setup-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/commands/gateway.ts
  - packages/cli/src/commands/uninstall.ts
  - packages/cli/src/index.ts
  - scripts/install.sh
  - scripts/update.sh
autonomous: true
requirements:
  - SC-01
  - SC-05

must_haves:
  truths:
    - "User types `tek gateway start` and the gateway spawns in the background, printing port and PID"
    - "User types `tek gateway stop` and the running gateway process terminates cleanly"
    - "User types `tek gateway status` and sees whether gateway is running with port/PID info"
    - "User types `tek uninstall`, confirms with UNINSTALL, and all traces are removed (files, config, db, keychain)"
    - "`tek uninstall` prints PATH removal instructions instead of editing shell profile"
    - "install.sh and update.sh reference `tek gateway start` instead of raw node commands"
  artifacts:
    - path: "packages/cli/src/commands/gateway.ts"
      provides: "Gateway subcommand group (start/stop/status)"
      exports: ["gatewayCommand"]
    - path: "packages/cli/src/commands/uninstall.ts"
      provides: "Uninstall command with destructive confirmation"
      exports: ["uninstallCommand"]
  key_links:
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/gateway.ts"
      via: "program.addCommand(gatewayCommand)"
      pattern: "addCommand.*gatewayCommand"
    - from: "packages/cli/src/commands/gateway.ts"
      to: "packages/cli/src/lib/discovery.ts"
      via: "discoverGateway() for status/stop and startup polling"
      pattern: "discoverGateway"
    - from: "packages/cli/src/commands/uninstall.ts"
      to: "@napi-rs/keyring"
      via: "keychain entry deletion loop"
      pattern: "Entry.*deletePassword"
---

<objective>
Add `tek gateway start|stop|status` subcommand group and `tek uninstall` command to the CLI. Update install/update scripts to reference the new gateway command.

Purpose: Users no longer need to know internal paths to start the gateway. Uninstall provides a clean one-command removal for testing and permanent removal.
Output: Two new Commander command modules registered in the CLI entry point, updated shell scripts.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-cli-setup-polish-gateway-subcommand-skippable-setup-steps-full-model-catalog-recommended-models-tek-uninstall/14-RESEARCH.md

@packages/cli/src/index.ts
@packages/cli/src/commands/config.ts
@packages/cli/src/lib/discovery.ts
@packages/core/src/config/constants.ts
@packages/core/src/config/types.ts
@packages/cli/src/vault/keychain.ts
@scripts/install.sh
@scripts/update.sh
@scripts/reset.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gateway subcommand group and uninstall command</name>
  <files>
    packages/cli/src/commands/gateway.ts
    packages/cli/src/commands/uninstall.ts
    packages/cli/src/index.ts
  </files>
  <action>
Create `packages/cli/src/commands/gateway.ts` with a Commander subcommand group following the existing pattern in config.ts:

**gateway start:**
- Check if already running via `discoverGateway()`. If running, print "Gateway already running on 127.0.0.1:{port} (PID {pid})" and exit.
- Accept `--foreground` option (default: background).
- Derive install directory at runtime: resolve `process.argv[1]` through symlinks via `realpathSync()`, then navigate up 3 levels from `packages/cli/dist/index.js` to get the install root. Fall back to `~/tek` if resolution fails.
- Compute gateway entry point: `{installDir}/packages/gateway/dist/index.js`
- If `--foreground`: spawn with `stdio: "inherit"`, forward exit code.
- If background (default): spawn with `detached: true, stdio: "ignore"`, call `child.unref()`.
- After spawning background: poll `discoverGateway()` every 250ms for up to 10 seconds. On success, print `Gateway started on 127.0.0.1:{port} (PID {pid})`. On timeout, print error suggesting checking logs.

**gateway stop:**
- Call `discoverGateway()`. If not running, print "Gateway is not running." and exit.
- Send `SIGTERM` to the PID. Wait up to 5 seconds polling for the process to die (process.kill(pid, 0) in try/catch). Print "Gateway stopped." on success, "Failed to stop gateway" on timeout.

**gateway status:**
- Call `discoverGateway()`. Print running state with port/PID or "Gateway is not running."

Create `packages/cli/src/commands/uninstall.ts`:

- Import `createInterface` from `node:readline` for the UNINSTALL confirmation prompt (same pattern as reset.sh but uses `UNINSTALL` confirmation word).
- Show what will be removed:
  - Install directory (derived same way as gateway command)
  - Config directory (`~/.config/tek`)
  - Database (`~/.config/tek/tek.db`)
  - Memory files (`~/.config/tek/memory/`)
  - Keychain entries (all provider API keys + auth token)
  - Launchd plist at `~/Library/LaunchAgents/com.tek.gateway.plist` IF it exists
- Prompt: "Type 'UNINSTALL' to confirm:"
- On confirmation:
  1. Stop gateway if running (same logic as gateway stop)
  2. Remove launchd plist if exists (`rm -f`)
  3. Delete keychain entries: iterate over known accounts `["api-key:anthropic", "api-key:openai", "api-key:ollama", "api-key:venice", "api-key:google", "api-endpoint-token"]`, wrap each `Entry.deletePassword()` in try/catch (skip missing)
  4. Remove config directory (`rm -rf ~/.config/tek`)
  5. Remove install directory (`rm -rf {installDir}`)
  6. Print PATH removal instructions: "Remove this line from your shell profile (~/.zshrc or ~/.bashrc):" followed by the PATH export line
  7. Print "Tek uninstalled."
- On cancel, print "Cancelled." and exit.

In `packages/cli/src/index.ts`:
- Import `gatewayCommand` from `./commands/gateway.js`
- Import `uninstallCommand` from `./commands/uninstall.js`
- Add both with `program.addCommand(gatewayCommand)` and `program.addCommand(uninstallCommand)`
- Update the default action's "Gateway is not running" message to suggest `tek gateway start` instead of the current generic message
  </action>
  <verify>
Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/cli/tsconfig.json --noEmit` to verify TypeScript compiles without errors. Verify the new command files exist and export the expected symbols.
  </verify>
  <done>
`tek gateway start|stop|status` commands exist and compile. `tek uninstall` command exists with destructive confirmation and full cleanup logic. Both commands registered in CLI entry point.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update install and update scripts</name>
  <files>
    scripts/install.sh
    scripts/update.sh
  </files>
  <action>
In `scripts/install.sh`:
- At the end, replace the "To add tek to your PATH" block with:
  ```
  echo "To add tek to your PATH, add this line to your shell profile (~/.zshrc or ~/.bashrc):"
  echo "  export PATH=\"$INSTALL_DIR/bin:\$PATH\""
  echo ""
  echo "Then start the gateway:"
  echo "  tek gateway start"
  ```

In `scripts/update.sh`:
- Replace the final line `echo "Start with: node $INSTALL_DIR/packages/gateway/dist/index.js"` with:
  ```
  echo "Start the gateway:"
  echo "  tek gateway start"
  ```
  </action>
  <verify>
Read both scripts and confirm the updated final messages reference `tek gateway start` rather than raw node commands. Run `bash -n /Users/hitekmedia/Documents/GitHub/tek/scripts/install.sh && bash -n /Users/hitekmedia/Documents/GitHub/tek/scripts/update.sh` to verify shell syntax.
  </verify>
  <done>
Both install.sh and update.sh print `tek gateway start` in their completion messages. No raw `node .../index.js` references remain.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p packages/cli/tsconfig.json --noEmit` passes
2. `grep -r "gateway" packages/cli/src/commands/gateway.ts` shows start/stop/status subcommands
3. `grep -r "uninstall\|UNINSTALL" packages/cli/src/commands/uninstall.ts` shows confirmation pattern
4. `grep "tek gateway start" scripts/install.sh scripts/update.sh` shows updated messaging
5. `grep "node.*gateway.*index" scripts/update.sh` returns nothing (old pattern removed)
</verification>

<success_criteria>
- `tek gateway start` spawns gateway in background, polls for runtime.json, prints port/PID
- `tek gateway stop` sends SIGTERM, waits for clean shutdown
- `tek gateway status` reports running state
- `tek uninstall` confirms with UNINSTALL, removes files/config/keychain/launchd, prints PATH instructions
- install.sh and update.sh reference `tek gateway start`
</success_criteria>

<output>
After completion, create `.planning/phases/14-cli-setup-polish-gateway-subcommand-skippable-setup-steps-full-model-catalog-recommended-models-tek-uninstall/14-01-SUMMARY.md`
</output>
