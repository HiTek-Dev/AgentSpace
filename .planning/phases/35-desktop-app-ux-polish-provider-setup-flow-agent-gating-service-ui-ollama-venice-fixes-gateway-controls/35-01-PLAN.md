---
phase: 35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src-tauri/capabilities/default.json
  - apps/desktop/src/views/ProvidersView.tsx
  - apps/desktop/src/components/providers/ProviderDetail.tsx
  - apps/desktop/src/views/ServicesView.tsx
autonomous: true
requirements: [UXP-01, UXP-02, UXP-03]

must_haves:
  truths:
    - "Gateway start/stop/restart buttons in desktop app execute tek gateway commands successfully"
    - "Clicking a provider card hides the provider grid and shows the config form with a back button"
    - "Clicking back in provider detail returns to the provider grid"
    - "Clicking a service card hides the service grid and shows the config form with a back button"
    - "Clicking back in service detail returns to the service grid"
  artifacts:
    - path: "apps/desktop/src-tauri/capabilities/default.json"
      provides: "Shell execute permission for tek command"
      contains: "shell:allow-execute"
    - path: "apps/desktop/src/views/ProvidersView.tsx"
      provides: "Inline detail pattern for provider configuration"
      contains: "onBack"
    - path: "apps/desktop/src/views/ServicesView.tsx"
      provides: "Inline detail pattern for service configuration"
      contains: "onBack"
  key_links:
    - from: "apps/desktop/src-tauri/capabilities/default.json"
      to: "apps/desktop/src/hooks/useGatewayControl.ts"
      via: "Tauri shell plugin permission grants Command.create('tek') execution rights"
      pattern: "shell:allow-execute"
    - from: "apps/desktop/src/views/ProvidersView.tsx"
      to: "apps/desktop/src/components/providers/ProviderDetail.tsx"
      via: "selectedProvider state toggles between grid and detail views"
      pattern: "selectedProvider.*ProviderDetail"
---

<objective>
Fix gateway shell controls and restructure provider/service UIs to inline detail pattern.

Purpose: Gateway start/stop/restart buttons silently fail because Tauri shell permissions only grant URL opening (`shell:default`). Provider and service configuration UIs show detail panels below the card grid instead of replacing the grid with an inline config form. This plan fixes the shell permissions and restructures both views.

Output: Working gateway controls from desktop, inline provider config flow with back button, inline service config flow with back button.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-RESEARCH.md

@apps/desktop/src-tauri/capabilities/default.json
@apps/desktop/src/views/ProvidersView.tsx
@apps/desktop/src/components/providers/ProviderDetail.tsx
@apps/desktop/src/views/ServicesView.tsx
@apps/desktop/src/hooks/useGatewayControl.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Tauri shell capabilities for gateway control</name>
  <files>apps/desktop/src-tauri/capabilities/default.json</files>
  <action>
Replace `"shell:default"` in the permissions array with proper shell execute permissions that allow `Command.create("tek", [...])` to work.

Add these entries to the permissions array (replacing `"shell:default"`):
```json
"shell:allow-execute",
{
  "identifier": "shell:allow-execute",
  "allow": [
    {
      "name": "tek",
      "cmd": "tek",
      "args": true
    }
  ]
}
```

The `name` field in the scope must match the first argument to `Command.create()` in `useGatewayControl.ts` (which is `"tek"`). Setting `args: true` allows any arguments (gateway start, gateway stop, etc.).

Also add `"shell:allow-kill"` permission so spawned processes can be terminated if needed.

Note: The `useGatewayControl.ts` hook already has the correct `Command.create("tek", ["gateway", "start"])` calls -- this task only fixes the permissions that gate those calls.
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && node -e "const j=JSON.parse(require('fs').readFileSync('apps/desktop/src-tauri/capabilities/default.json','utf8')); const perms=JSON.stringify(j.permissions); console.log('has shell:allow-execute:', perms.includes('shell:allow-execute')); console.log('has tek cmd:', perms.includes('\"cmd\":\"tek\"') || perms.includes('\"cmd\": \"tek\"')); console.log('no shell:default:', !perms.includes('\"shell:default\"'))"</automated>
    <manual>Run `tauri dev`, go to Gateway view, click Start button -- gateway should start (check runtime.json)</manual>
  </verify>
  <done>Tauri capabilities include shell:allow-execute with tek command scope; Command.create("tek") calls succeed at runtime</done>
</task>

<task type="auto">
  <name>Task 2: Refactor ProvidersView to inline detail pattern</name>
  <files>
    apps/desktop/src/views/ProvidersView.tsx
    apps/desktop/src/components/providers/ProviderDetail.tsx
  </files>
  <action>
Refactor ProvidersView.tsx to show EITHER the provider grid OR the provider detail -- never both simultaneously.

**ProvidersView.tsx changes:**
1. When `selectedProvider` is set, render only the ProviderDetail (not the grid)
2. When `selectedProvider` is null, render the grid with header
3. Pass an `onBack` callback to ProviderDetail that sets `selectedProvider` to null
4. Move the header section ("Providers" title + description) above the conditional, but only show it when grid is visible
5. Keep the connection warning always visible

Current structure (both visible):
```
<Header />
<Grid>{cards}</Grid>
{selected && <ProviderDetail below />}
```

Target structure (exclusive):
```
{selectedProvider ? (
  <ProviderDetail with back button />
) : (
  <>
    <Header />
    <Grid>{cards}</Grid>
  </>
)}
```

**ProviderDetail.tsx changes:**
1. Add `onBack?: () => void` to ProviderDetailProps
2. Add a back button at the top of the component (before the Card):
   - Import `ArrowLeft` from lucide-react
   - Render: `<button onClick={onBack} className="mb-4 flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"><ArrowLeft className="size-4" /> Back to Providers</button>`
3. Remove the `mt-4` class from the Card (it's no longer positioned below a grid)

The detail should show the provider name prominently since the grid is hidden.
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && npx tsc --noEmit --project apps/desktop/tsconfig.app.json 2>&1 | head -20</automated>
    <manual>Open Providers view, click a provider card -- grid hides, detail shows with back button. Click back -- grid returns.</manual>
  </verify>
  <done>Provider grid and detail are mutually exclusive; detail view has a back button that returns to grid; no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 3: Refactor ServicesView to inline detail pattern</name>
  <files>apps/desktop/src/views/ServicesView.tsx</files>
  <action>
Refactor ServicesView.tsx to show EITHER the service grid OR the service setup form -- never both simultaneously. Currently the grid stays visible and the setup form appears below it.

**Changes:**
1. When `selectedService` is set, render only the service setup component (TelegramSetup or BraveSetup) with a back button above it
2. When `selectedService` is null, render the header + card grid
3. Add `ArrowLeft` import from lucide-react
4. Back button: `<button onClick={() => setSelectedService(null)} className="mb-4 flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"><ArrowLeft className="size-4" /> Back to Services</button>`
5. Show the service name as a heading when detail is visible (e.g., "Telegram Setup" or "Brave Search Setup")

Current structure:
```
<Header />
<Grid>{cards}</Grid>
{selectedService === "telegram" && <TelegramSetup />}
{selectedService === "brave" && <BraveSetup />}
```

Target structure:
```
{selectedService ? (
  <div className="p-6">
    <back button />
    <h2>{service name} Setup</h2>
    {selectedService === "telegram" ? <TelegramSetup /> : <BraveSetup />}
  </div>
) : (
  <div className="flex h-full flex-col gap-6 overflow-y-auto p-6">
    <Header />
    <Grid>{cards}</Grid>
  </div>
)}
```

Remove the `animate-in` wrapper divs and `ChevronDown` rotation since we no longer expand inline -- we replace the whole view.
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && npx tsc --noEmit --project apps/desktop/tsconfig.app.json 2>&1 | head -20</automated>
    <manual>Open Services view, click Telegram card -- grid hides, Telegram setup shows with back button. Click back -- grid returns.</manual>
  </verify>
  <done>Service grid and detail are mutually exclusive; setup form has back button; no TypeScript errors</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit --project apps/desktop/tsconfig.app.json`
2. Capabilities JSON is valid: parse with JSON.parse and verify shell:allow-execute present
3. No references to "shell:default" remain in capabilities
</verification>

<success_criteria>
- Gateway start/stop/restart works from desktop app (Tauri shell permissions fixed)
- Provider UI: clicking card shows inline detail with back button, grid hidden
- Service UI: clicking card shows inline setup with back button, grid hidden
- Zero TypeScript errors in desktop app
</success_criteria>

<output>
After completion, create `.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-01-SUMMARY.md`
</output>
