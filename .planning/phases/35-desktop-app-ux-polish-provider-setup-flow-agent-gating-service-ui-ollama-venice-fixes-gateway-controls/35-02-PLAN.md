---
phase: 35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/ws/vault-handlers.ts
  - apps/desktop/src/views/ProvidersView.tsx
  - apps/desktop/src/components/providers/ProviderDetail.tsx
autonomous: true
requirements: [UXP-04, UXP-05]

must_haves:
  truths:
    - "Ollama provider.models.list returns discovered models from localhost:11434 instead of empty array"
    - "Clicking Discover Models for Ollama populates the model table with found models"
    - "Venice Save & Test saves the key first then tests it, no more 'No API key configured' error"
    - "Venice known models list includes at least 5 models (llama-3.3-70b, deepseek-r1-671b, dolphin-2.9.3-mistral-7b, llama-3.2-3b, nous-theta-8b)"
  artifacts:
    - path: "packages/gateway/src/ws/vault-handlers.ts"
      provides: "Fixed Ollama provider.models.list and expanded Venice models"
      contains: "handleProviderModelsList"
    - path: "apps/desktop/src/views/ProvidersView.tsx"
      provides: "Ollama discovery results wired to model table"
      contains: "handleDiscover"
    - path: "apps/desktop/src/components/providers/ProviderDetail.tsx"
      provides: "Combined Save & Test button for non-Ollama providers"
      contains: "Save & Test"
  key_links:
    - from: "packages/gateway/src/ws/vault-handlers.ts"
      to: "http://localhost:11434/api/tags"
      via: "handleProviderModelsList for ollama fetches discover endpoint"
      pattern: "localhost:11434/api/tags"
    - from: "apps/desktop/src/components/providers/ProviderDetail.tsx"
      to: "apps/desktop/src/views/ProvidersView.tsx"
      via: "onSave callback saves key before onTest runs"
      pattern: "onSave.*onTest"
---

<objective>
Fix Ollama model discovery integration and Venice key testing flow in both gateway and desktop.

Purpose: Ollama discovery at localhost:11434 works at the gateway level but results are discarded in the desktop UI. The provider.models.list RPC for Ollama returns empty `[]` instead of calling the discover endpoint. Venice "test key" fails with "No API key configured" because users click Test before Save, and the known models list is incomplete. This plan fixes both provider integrations end-to-end.

Output: Working Ollama model discovery and display, working Venice save+test flow, expanded Venice model catalog.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-RESEARCH.md

@packages/gateway/src/ws/vault-handlers.ts
@apps/desktop/src/views/ProvidersView.tsx
@apps/desktop/src/components/providers/ProviderDetail.tsx
@apps/desktop/src/components/providers/ModelTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Ollama provider.models.list and wire discovery results in desktop</name>
  <files>
    packages/gateway/src/ws/vault-handlers.ts
    apps/desktop/src/views/ProvidersView.tsx
  </files>
  <action>
**Gateway fix (vault-handlers.ts):**

1. Make `handleProviderModelsList` async (currently sync)
2. For ollama provider, instead of returning `KNOWN_MODELS["ollama"]` (empty array), fetch from the Ollama discover endpoint:
   ```typescript
   export async function handleProviderModelsList(transport: Transport, msg: ProviderModelsList): Promise<void> {
     if (msg.provider === "ollama") {
       // Try to discover local Ollama models
       try {
         const res = await fetch("http://localhost:11434/api/tags");
         if (res.ok) {
           const data = (await res.json()) as { models?: Array<{ name: string; size?: number }> };
           const models = (data.models ?? []).map((m) => ({
             modelId: m.name,
             name: m.name.replace(/:latest$/, ""),
             tier: "standard" as const,
           }));
           transport.send({
             type: "provider.models.list.result",
             id: msg.id,
             provider: msg.provider,
             models,
           });
           return;
         }
       } catch {
         // Ollama not running, fall through to empty list
       }
     }

     const models = KNOWN_MODELS[msg.provider] ?? [];
     transport.send({
       type: "provider.models.list.result",
       id: msg.id,
       provider: msg.provider,
       models,
     });
   }
   ```
3. Update the call site in `server.ts` (if it doesn't already await) to handle the now-async function. Check `server.ts` for where `handleProviderModelsList` is called and add `await` if missing.

**Desktop fix (ProvidersView.tsx):**

4. Update `handleDiscover` to actually use the OllamaDiscoverResult. Currently the result is discarded (comment says "future iteration"). Wire it up:
   ```typescript
   const handleDiscover = async (url: string) => {
     if (!connected) return;
     try {
       const msg = createOllamaDiscover(url);
       const result = await request<OllamaDiscoverResult>(msg);
       if (result.type === "ollama.discover.result" && result.models && result.models.length > 0) {
         // Store discovered models to pass to ProviderDetail
         setDiscoveredModels(result.models.map(m => ({
           modelId: m.name,
           name: m.name.replace(/:latest$/, ""),
           tier: "standard",
         })));
       }
     } catch {
       // Error handling -- could set an error state
     }
   };
   ```
5. Add `discoveredModels` state to ProvidersView and pass it to ProviderDetail as a prop so the model table is populated after discovery
6. In ProviderDetail, when `provider === "ollama"` and discoveredModels are passed in, merge them into the models state (replacing the empty list from provider.models.list)
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && npx tsc --noEmit --project apps/desktop/tsconfig.app.json 2>&1 | head -20 && npx tsc --noEmit --project packages/gateway/tsconfig.json 2>&1 | head -20</automated>
    <manual>With Ollama running locally, open Providers view, click Ollama card, click Discover Models -- model table should populate with local models. Also verify provider.models.list returns models for Ollama.</manual>
  </verify>
  <done>Ollama provider.models.list returns discovered local models; desktop Discover Models button populates the model table; both TypeScript projects compile cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Fix Venice key test flow and expand known models</name>
  <files>
    packages/gateway/src/ws/vault-handlers.ts
    apps/desktop/src/components/providers/ProviderDetail.tsx
  </files>
  <action>
**Gateway fix (vault-handlers.ts):**

1. Expand Venice known models in KNOWN_MODELS to include at least 5 models:
   ```typescript
   venice: [
     { modelId: "llama-3.3-70b", name: "Llama 3.3 70B", tier: "standard" },
     { modelId: "deepseek-r1-671b", name: "DeepSeek R1 671B", tier: "high" },
     { modelId: "dolphin-2.9.3-mistral-7b", name: "Dolphin 2.9.3 Mistral 7B", tier: "budget" },
     { modelId: "llama-3.2-3b", name: "Llama 3.2 3B", tier: "budget" },
     { modelId: "nous-theta-8b", name: "Nous Theta 8B", tier: "budget" },
   ],
   ```

**Desktop fix (ProviderDetail.tsx):**

2. Replace the separate Save and Test buttons with a combined flow for non-Ollama providers:
   - Replace `handleSave` and `handleTest` with `handleSaveAndTest`:
     ```typescript
     const handleSaveAndTest = async () => {
       if (isOllama) {
         // Ollama just saves the URL, no key test needed
         onSave(ollamaUrl);
         return;
       }
       if (!apiKey && !configured) return;

       // If there's a new key entered, save it first
       if (apiKey) {
         onSave(apiKey);
         // Small delay to let keychain persist
         await new Promise(r => setTimeout(r, 300));
       }

       // Now test the saved key
       setTesting(true);
       setTestResult(null);
       try {
         const result = await onTest(provider);
         setTestResult(result);
       } catch {
         setTestResult({ valid: false, error: "Test request failed" });
       } finally {
         setTesting(false);
       }
     };
     ```
   - Replace the current two-button layout (Test Key + Save) with a single "Save & Test" button for non-Ollama providers:
     ```tsx
     <Button onClick={handleSaveAndTest} disabled={testing || (!apiKey && !configured)}>
       {testing ? <Loader2 className="size-4 animate-spin" /> : <FlaskConical className="size-4" />}
       {testing ? "Testing..." : apiKey ? "Save & Test" : "Test Key"}
     </Button>
     ```
   - Keep a separate Save button for Ollama (URL save only)
   - Remove the old standalone Save button at the bottom of the form for non-Ollama providers (the combined button replaces it)
3. Move the Save & Test button to be inline with the API key input (where the current Test Key button is), removing the separate bottom Save button section for non-Ollama providers
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && npx tsc --noEmit --project apps/desktop/tsconfig.app.json 2>&1 | head -20 && node -e "const f=require('fs').readFileSync('packages/gateway/src/ws/vault-handlers.ts','utf8'); console.log('venice models count:', (f.match(/venice:.*?\[(.+?)\]/s)?.[1]?.split('{').length - 1) || 0); console.log('has dolphin:', f.includes('dolphin-2.9.3')); console.log('has nous-theta:', f.includes('nous-theta-8b'))"</automated>
    <manual>Open Venice provider, enter a key, click "Save & Test" -- key should save first, then test should succeed (no "No API key configured" error). Venice models should show 5 entries.</manual>
  </verify>
  <done>Venice key test no longer fails with "No API key configured" because save happens before test; Venice known models list has 5+ entries; Ollama retains separate Save button for URL; TypeScript compiles cleanly</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for both gateway and desktop: `npx tsc --noEmit --project packages/gateway/tsconfig.json && npx tsc --noEmit --project apps/desktop/tsconfig.app.json`
2. Venice known models count >= 5 in vault-handlers.ts
3. handleProviderModelsList is async and handles ollama specially
4. ProviderDetail has "Save & Test" combined button for non-Ollama providers
</verification>

<success_criteria>
- Ollama provider.models.list returns locally discovered models instead of empty array
- Ollama Discover Models button in desktop populates model table
- Venice "Save & Test" saves key before testing, eliminating the "No API key configured" race
- Venice known models includes 5 models (llama-3.3-70b, deepseek-r1-671b, dolphin-2.9.3-mistral-7b, llama-3.2-3b, nous-theta-8b)
- Both TypeScript projects compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-02-SUMMARY.md`
</output>
