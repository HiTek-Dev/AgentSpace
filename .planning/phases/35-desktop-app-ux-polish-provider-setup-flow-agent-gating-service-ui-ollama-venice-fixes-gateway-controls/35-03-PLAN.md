---
phase: 35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls
plan: 03
type: execute
wave: 2
depends_on: [35-01, 35-02]
files_modified:
  - apps/desktop/src/stores/app-store.ts
  - apps/desktop/src/components/ui/nav-item.tsx
  - apps/desktop/src/components/NavSidebar.tsx
  - apps/desktop/src/App.tsx
  - apps/desktop/src/hooks/useAvailableModels.ts
  - apps/desktop/src/views/AgentsView.tsx
  - apps/desktop/src/components/agents/ModelRoutingEditor.tsx
autonomous: true
requirements: [UXP-06, UXP-07, UXP-08, UXP-09]

must_haves:
  truths:
    - "Agents tab is visually disabled and unclickable when no providers are configured"
    - "Agents tab becomes enabled after at least one provider is configured"
    - "On startup after gateway connects, if no providers configured, app redirects to providers page"
    - "Agent create form model select shows provider/model combos like 'anthropic/Claude Sonnet 4' fetched from gateway"
    - "Model routing editor shows provider/model combos instead of hardcoded list"
    - "No hardcoded MODEL_OPTIONS arrays remain in AgentsView or ModelRoutingEditor"
  artifacts:
    - path: "apps/desktop/src/stores/app-store.ts"
      provides: "hasConfiguredProvider state and setter"
      contains: "hasConfiguredProvider"
    - path: "apps/desktop/src/components/ui/nav-item.tsx"
      provides: "NavItem with disabled prop support"
      contains: "disabled"
    - path: "apps/desktop/src/components/NavSidebar.tsx"
      provides: "Agents tab conditionally disabled"
      contains: "hasConfiguredProvider"
    - path: "apps/desktop/src/App.tsx"
      provides: "Startup provider check that redirects to providers page"
      contains: "hasConfiguredProvider"
    - path: "apps/desktop/src/hooks/useAvailableModels.ts"
      provides: "Hook fetching provider/model combos from gateway"
      exports: ["useAvailableModels"]
    - path: "apps/desktop/src/views/AgentsView.tsx"
      provides: "Agent create form with dynamic model select"
      contains: "useAvailableModels"
    - path: "apps/desktop/src/components/agents/ModelRoutingEditor.tsx"
      provides: "Model routing with dynamic model options"
      contains: "useAvailableModels"
  key_links:
    - from: "apps/desktop/src/App.tsx"
      to: "apps/desktop/src/stores/app-store.ts"
      via: "ViewRouter reads hasConfiguredProvider from store"
      pattern: "hasConfiguredProvider"
    - from: "apps/desktop/src/components/NavSidebar.tsx"
      to: "apps/desktop/src/stores/app-store.ts"
      via: "NavSidebar reads hasConfiguredProvider to disable Agents tab"
      pattern: "hasConfiguredProvider"
    - from: "apps/desktop/src/hooks/useAvailableModels.ts"
      to: "packages/gateway/src/ws/vault-handlers.ts"
      via: "Fetches vault.keys.list then provider.models.list per configured provider"
      pattern: "createVaultKeysList.*createProviderModelsList"
    - from: "apps/desktop/src/views/AgentsView.tsx"
      to: "apps/desktop/src/hooks/useAvailableModels.ts"
      via: "Agent create form consumes models from hook"
      pattern: "useAvailableModels"
---

<objective>
Add provider gating for agents, startup provider check, and dynamic model pickers with provider/model format.

Purpose: The Agents tab is accessible with zero configured providers (useless state). The agent create form and model routing editor use hardcoded model lists that don't reflect what's actually configured. On app startup, users should be guided to configure providers before accessing other features. This plan gates the UI behind provider configuration and replaces all hardcoded model lists with dynamic provider/model combos.

Output: Agents tab disabled until provider configured, startup redirect to providers page, dynamic model pickers showing "provider/model" format.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-RESEARCH.md
@.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-01-SUMMARY.md
@.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-02-SUMMARY.md

@apps/desktop/src/stores/app-store.ts
@apps/desktop/src/components/ui/nav-item.tsx
@apps/desktop/src/components/NavSidebar.tsx
@apps/desktop/src/App.tsx
@apps/desktop/src/views/AgentsView.tsx
@apps/desktop/src/components/agents/ModelRoutingEditor.tsx
@apps/desktop/src/hooks/useGatewayRpc.ts
@apps/desktop/src/lib/gateway-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add provider gating to app store, nav sidebar, and startup check</name>
  <files>
    apps/desktop/src/stores/app-store.ts
    apps/desktop/src/components/ui/nav-item.tsx
    apps/desktop/src/components/NavSidebar.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
**app-store.ts:**
1. Add `hasConfiguredProvider: boolean` and `setHasConfiguredProvider: (v: boolean) => void` to AppState interface
2. Initialize `hasConfiguredProvider` as `false`
3. Add setter: `setHasConfiguredProvider: (v) => set({ hasConfiguredProvider: v })`

**nav-item.tsx:**
1. Add `disabled?: boolean` and `tooltip?: string` to NavItemProps
2. When disabled is true:
   - Add `pointer-events-none opacity-40` classes
   - Prevent onClick from firing (early return or conditional)
   - Optionally show tooltip on hover using `title` attribute
3. Implementation:
   ```typescript
   interface NavItemProps {
     icon: LucideIcon;
     label: string;
     active: boolean;
     onClick: () => void;
     statusDot?: "green" | "red" | "gray";
     disabled?: boolean;
     tooltip?: string;
   }

   export function NavItem({ icon: Icon, label, active, onClick, statusDot, disabled, tooltip }: NavItemProps) {
     return (
       <button
         onClick={disabled ? undefined : onClick}
         disabled={disabled}
         title={tooltip}
         className={cn(
           "flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors",
           disabled
             ? "cursor-not-allowed opacity-40 text-muted-foreground"
             : active
               ? "bg-accent text-accent-foreground"
               : "text-muted-foreground hover:bg-accent/50 hover:text-foreground",
         )}
       >
         ...existing content...
       </button>
     );
   }
   ```

**NavSidebar.tsx:**
1. Read `hasConfiguredProvider` from app store:
   ```typescript
   const hasConfiguredProvider = useAppStore((s) => s.hasConfiguredProvider);
   ```
2. Pass `disabled` and `tooltip` to the Agents NavItem:
   ```tsx
   <NavItem
     icon={Bot}
     label="Agents"
     active={currentView === "agents" || currentView === "agent-detail"}
     onClick={() => navigate("agents")}
     disabled={!hasConfiguredProvider}
     tooltip={!hasConfiguredProvider ? "Configure a provider first" : undefined}
   />
   ```

**App.tsx (ViewRouter):**
1. Import `useGatewayRpc` and gateway client functions
2. Add a startup effect that runs after gateway connects:
   ```typescript
   const { request, connected } = useGatewayRpc();
   const setHasConfiguredProvider = useAppStore((s) => s.setHasConfiguredProvider);
   const hasConfiguredProvider = useAppStore((s) => s.hasConfiguredProvider);

   useEffect(() => {
     if (!connected) return;

     async function checkProviders() {
       try {
         const result = await request<VaultKeysListResult>(createVaultKeysList());
         if (result.type === "vault.keys.list.result" && result.providers) {
           // LLM providers only (exclude service keys like telegram, brave, tavily)
           const SERVICE_KEYS = ["telegram", "brave", "tavily"];
           const hasProvider = result.providers.some(
             (p) => p.configured && !SERVICE_KEYS.includes(p.provider)
           );
           setHasConfiguredProvider(hasProvider);

           // If no providers and not already on providers/onboarding/landing, redirect
           if (!hasProvider && !["providers", "onboarding", "landing"].includes(currentView)) {
             setCurrentView("providers");
           }
         }
       } catch {
         // Gateway may not support this message -- fail open
       }
     }

     checkProviders();
   }, [connected]);
   ```
3. Import `createVaultKeysList` and `VaultKeysListResult` from gateway-client
4. Also update hasConfiguredProvider after any provider save (this happens naturally when ProvidersView calls fetchProviders and could additionally call setHasConfiguredProvider, but the startup check is the critical path)
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && npx tsc --noEmit --project apps/desktop/tsconfig.app.json 2>&1 | head -20</automated>
    <manual>Start app with no providers configured -- should redirect to Providers page. Agents tab in sidebar should be grayed out and unclickable. Configure a provider, return to sidebar -- Agents tab should be active.</manual>
  </verify>
  <done>Agents tab disabled when no providers configured; startup redirects to providers page; hasConfiguredProvider state in Zustand store drives both behaviors; NavItem supports disabled prop</done>
</task>

<task type="auto">
  <name>Task 2: Create useAvailableModels hook and wire dynamic model pickers</name>
  <files>
    apps/desktop/src/hooks/useAvailableModels.ts
    apps/desktop/src/views/AgentsView.tsx
    apps/desktop/src/components/agents/ModelRoutingEditor.tsx
  </files>
  <action>
**useAvailableModels.ts (NEW FILE):**
Create a shared hook that fetches available models from all configured LLM providers via gateway RPCs.

```typescript
import { useState, useCallback, useEffect } from "react";
import { useGatewayRpc } from "@/hooks/useGatewayRpc";
import {
  createVaultKeysList,
  createProviderModelsList,
  type VaultKeysListResult,
  type ProviderModelsListResult,
} from "@/lib/gateway-client";

export interface ModelOption {
  value: string;       // provider:modelId (e.g. "anthropic:claude-sonnet-4-20250514")
  label: string;       // provider/display name (e.g. "anthropic/Claude Sonnet 4")
  provider: string;    // provider key
  modelId: string;     // raw model ID
  tier?: string;       // high/standard/budget
}

const SERVICE_KEYS = ["telegram", "brave", "tavily"];

export function useAvailableModels() {
  const { request, connected } = useGatewayRpc();
  const [models, setModels] = useState<ModelOption[]>([]);
  const [loading, setLoading] = useState(false);

  const fetchModels = useCallback(async () => {
    if (!connected) return;
    setLoading(true);
    try {
      // Get configured providers
      const listResult = await request<VaultKeysListResult>(createVaultKeysList());
      if (listResult.type !== "vault.keys.list.result" || !listResult.providers) {
        setModels([]);
        return;
      }

      const configured = listResult.providers
        .filter((p) => p.configured && !SERVICE_KEYS.includes(p.provider));

      const allModels: ModelOption[] = [];

      for (const prov of configured) {
        try {
          const result = await request<ProviderModelsListResult>(
            createProviderModelsList(prov.provider)
          );
          if (result.type === "provider.models.list.result" && result.models) {
            for (const m of result.models) {
              allModels.push({
                value: `${prov.provider}:${m.modelId}`,
                label: `${prov.provider}/${m.name}`,
                provider: prov.provider,
                modelId: m.modelId,
                tier: m.tier,
              });
            }
          }
        } catch {
          // Skip provider on error
        }
      }

      setModels(allModels);
    } catch {
      setModels([]);
    } finally {
      setLoading(false);
    }
  }, [connected, request]);

  useEffect(() => {
    fetchModels();
  }, [fetchModels]);

  return { models, loading, refetch: fetchModels };
}
```

**AgentsView.tsx:**
1. Import `useAvailableModels` from `@/hooks/useAvailableModels`
2. Call hook at top of component: `const { models: availableModels, loading: modelsLoading } = useAvailableModels();`
3. Replace the hardcoded `<select>` for model in the create form with a dynamic one:
   ```tsx
   <select value={newModel} onChange={(e) => setNewModel(e.target.value)} ...>
     {availableModels.length > 0 ? (
       availableModels.map((m) => (
         <option key={m.value} value={m.modelId} className="bg-card">
           {m.label}
         </option>
       ))
     ) : (
       <option value="" className="bg-card">
         {modelsLoading ? "Loading models..." : "No models available"}
       </option>
     )}
   </select>
   ```
4. Update the default `newModel` state: instead of hardcoding `"claude-sonnet-4-20250514"`, set it to empty string initially and auto-select the first available model when models load:
   ```typescript
   const [newModel, setNewModel] = useState("");

   useEffect(() => {
     if (availableModels.length > 0 && !newModel) {
       setNewModel(availableModels[0].modelId);
     }
   }, [availableModels, newModel]);
   ```
5. Update `formatModelName` to handle the provider/model format -- check if the model matches an available model and show its label, otherwise fall back to existing logic
6. Remove the hardcoded model options from the agent card display -- use the availableModels to look up display names, falling back to the existing formatModelName for unknown models

**ModelRoutingEditor.tsx:**
1. Import `useAvailableModels` from `@/hooks/useAvailableModels`
2. Call hook: `const { models: availableModels } = useAvailableModels();`
3. Replace the hardcoded `MODEL_OPTIONS` const with a dynamic one derived from the hook:
   ```typescript
   const dynamicModelOptions = [
     { value: "", label: "Default (use agent model)" },
     ...availableModels.map((m) => ({
       value: m.modelId,
       label: m.label, // e.g. "anthropic/Claude Sonnet 4"
     })),
   ];
   ```
4. Replace `MODEL_OPTIONS` usage in the render with `dynamicModelOptions`
5. Delete the hardcoded `MODEL_OPTIONS` const entirely
  </action>
  <verify>
    <automated>cd /Users/drew-mini/Documents/GitHub/tek && npx tsc --noEmit --project apps/desktop/tsconfig.app.json 2>&1 | head -20 && grep -c "MODEL_OPTIONS" apps/desktop/src/components/agents/ModelRoutingEditor.tsx apps/desktop/src/views/AgentsView.tsx 2>/dev/null || echo "No hardcoded MODEL_OPTIONS found (good)"</automated>
    <manual>Open Agents view, click Create Agent -- model dropdown should show "anthropic/Claude Sonnet 4", "openai/GPT-4o" etc. Open Agent Detail, go to Model Routing -- dropdowns should show same dynamic list. No hardcoded model names visible.</manual>
  </verify>
  <done>useAvailableModels hook fetches provider/model combos from gateway; AgentsView create form uses dynamic model list with provider/name format; ModelRoutingEditor uses dynamic list; no hardcoded MODEL_OPTIONS arrays remain</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit --project apps/desktop/tsconfig.app.json`
2. No hardcoded MODEL_OPTIONS in AgentsView or ModelRoutingEditor: `grep -c "MODEL_OPTIONS" apps/desktop/src/components/agents/ModelRoutingEditor.tsx apps/desktop/src/views/AgentsView.tsx` returns 0
3. useAvailableModels.ts exists and exports the hook
4. app-store.ts has hasConfiguredProvider state
5. NavItem supports disabled prop
</verification>

<success_criteria>
- Agents tab grayed out and unclickable when no providers configured
- App redirects to providers page on startup when no providers configured
- Agent create form shows "anthropic/Claude Sonnet 4" format in model picker
- Model routing editor shows "anthropic/Claude Sonnet 4" format in all dropdowns
- All model options are fetched dynamically from configured providers, no hardcoded lists
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-desktop-app-ux-polish-provider-setup-flow-agent-gating-service-ui-ollama-venice-fixes-gateway-controls/35-03-SUMMARY.md`
</output>
