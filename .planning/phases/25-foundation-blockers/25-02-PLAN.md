---
phase: 25-foundation-blockers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/package.json
  - apps/desktop/src/components/PageErrorFallback.tsx
  - apps/desktop/src/App.tsx
  - vitest.config.ts
  - packages/gateway/vitest.config.ts
  - packages/core/vitest.config.ts
  - packages/gateway/package.json
  - packages/core/package.json
autonomous: true
requirements:
  - FOUND-02

must_haves:
  truths:
    - "Desktop app renders a recovery UI with error message and Try Again button when a page component throws during render"
    - "Navigating to a different page automatically resets the error boundary without requiring Try Again click"
    - "pnpm test from repo root discovers Vitest workspace config and exits cleanly (no tests yet, but config valid)"
  artifacts:
    - path: "apps/desktop/src/components/PageErrorFallback.tsx"
      provides: "Error fallback component with error message display and Try Again button"
      exports: ["PageErrorFallback"]
    - path: "apps/desktop/src/App.tsx"
      provides: "ErrorBoundary wrapping ActivePage with resetKeys=[currentPage]"
      contains: "ErrorBoundary"
    - path: "vitest.config.ts"
      provides: "Root Vitest config with projects glob"
      contains: "projects"
    - path: "packages/gateway/vitest.config.ts"
      provides: "Gateway-specific Vitest config"
      contains: "name: 'gateway'"
  key_links:
    - from: "apps/desktop/src/App.tsx"
      to: "apps/desktop/src/components/PageErrorFallback.tsx"
      via: "FallbackComponent prop"
      pattern: "FallbackComponent.*PageErrorFallback"
    - from: "vitest.config.ts"
      to: "packages/*/vitest.config.ts"
      via: "projects glob"
      pattern: "projects.*packages"
---

<objective>
Add React error boundaries to the desktop app and configure Vitest workspace for the monorepo.

Purpose: Error boundaries prevent the desktop app from white-screening when a page component throws. Vitest workspace config enables `pnpm test` to discover and run tests across all packages (Phase 28 will create the actual tests).
Output: PageErrorFallback component, ErrorBoundary in App.tsx, root vitest.config.ts with per-package configs.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-foundation-blockers/25-RESEARCH.md
@apps/desktop/src/App.tsx
@apps/desktop/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add React error boundaries to desktop app</name>
  <files>
    apps/desktop/package.json
    apps/desktop/src/components/PageErrorFallback.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
    1. Install react-error-boundary: `pnpm add react-error-boundary --filter @tek/desktop`
    2. Create `apps/desktop/src/components/PageErrorFallback.tsx`:
       - Import `FallbackProps` from `react-error-boundary`.
       - Export a `PageErrorFallback` component that accepts `{ error, resetErrorBoundary }: FallbackProps`.
       - Render a centered flex column layout with:
         - A red exclamation icon or text indicator
         - "Something went wrong" heading (text-xl, font-semibold, text-red-400)
         - The error.message in a `<pre>` tag (text-sm, text-gray-400, max-w-md, overflow-auto, whitespace-pre-wrap)
         - A "Try Again" button that calls `resetErrorBoundary` (px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors)
       - Use Tailwind classes consistent with the existing dark theme (the app uses dark backgrounds).
    3. Update `apps/desktop/src/App.tsx`:
       - Add import: `import { ErrorBoundary } from 'react-error-boundary';`
       - Add import: `import { PageErrorFallback } from './components/PageErrorFallback';`
       - Wrap `<ActivePage />` with `<ErrorBoundary>`:
         ```tsx
         <ErrorBoundary
           FallbackComponent={PageErrorFallback}
           resetKeys={[currentPage]}
           onError={(error) => console.error('Page error:', error)}
         >
           <ActivePage />
         </ErrorBoundary>
         ```
       - The `resetKeys={[currentPage]}` ensures navigating to a different page auto-resets the boundary.
       - The ErrorBoundary must be INSIDE `<Layout>` so the sidebar/navigation remains visible during errors.
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && pnpm turbo build --filter=@tek/desktop` — desktop builds without errors. Verify `PageErrorFallback.tsx` exists and `App.tsx` contains `ErrorBoundary`.
  </verify>
  <done>
    Desktop app has ErrorBoundary wrapping page content inside Layout. PageErrorFallback component renders error message and Try Again button. Navigation resets error state via resetKeys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest workspace for monorepo</name>
  <files>
    vitest.config.ts
    packages/gateway/vitest.config.ts
    packages/core/vitest.config.ts
    packages/gateway/package.json
    packages/core/package.json
  </files>
  <action>
    1. Create root `vitest.config.ts` at repo root:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           projects: ['packages/*'],
         },
       });
       ```
       Use `projects` (NOT deprecated `workspace`). The glob `packages/*` will discover per-package configs.

    2. Create `packages/gateway/vitest.config.ts`:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           name: 'gateway',
           include: ['src/**/*.test.ts'],
         },
       });
       ```

    3. Create `packages/core/vitest.config.ts`:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           name: 'core',
           include: ['src/**/*.test.ts'],
         },
       });
       ```

    4. Add `"test": "vitest run"` script to `packages/gateway/package.json` and `packages/core/package.json` scripts sections. This enables Turborepo to run per-package tests via `turbo run test`.

    5. Do NOT create vitest configs for `apps/desktop` or `packages/cli` — those don't have tests in Phase 28's scope. They can be added later.

    6. Do NOT add vitest as a per-package devDependency — it's already installed at the root level and hoisted.
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx vitest run 2>&1` — should discover the workspace config and exit cleanly (no tests found is OK, no config errors). Also run `pnpm test` to verify Turborepo discovers the test scripts.
  </verify>
  <done>
    Root vitest.config.ts with projects glob exists. Per-package vitest configs exist for gateway and core. `pnpm test` from repo root discovers Vitest workspace and exits without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo build --filter=@tek/desktop` succeeds
2. `grep -c "ErrorBoundary" apps/desktop/src/App.tsx` returns at least 1
3. `cat apps/desktop/src/components/PageErrorFallback.tsx` exists with resetErrorBoundary
4. `npx vitest run` from repo root discovers workspace config without errors
5. `pnpm test` runs through Turborepo and exits cleanly
</verification>

<success_criteria>
- Desktop app wraps page content in ErrorBoundary with PageErrorFallback
- Error boundary resets when navigating between pages (resetKeys=[currentPage])
- Layout/sidebar remains visible when a page component throws
- Vitest workspace config at root discovers packages/gateway and packages/core
- pnpm test from repo root works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/25-foundation-blockers/25-02-SUMMARY.md`
</output>
