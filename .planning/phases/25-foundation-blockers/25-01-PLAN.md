---
phase: 25-foundation-blockers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/vault/index.ts
  - packages/core/src/vault/keychain.ts
  - packages/core/src/vault/providers.ts
  - packages/core/package.json
  - packages/core/tsconfig.json
  - packages/gateway/package.json
  - packages/gateway/src/ws/handlers.ts
  - packages/gateway/src/llm/provider.ts
  - packages/gateway/src/llm/registry.ts
  - packages/gateway/src/key-server/auth.ts
  - packages/gateway/src/key-server/routes.ts
  - packages/cli/package.json
  - packages/cli/src/commands/onboard.ts
  - packages/cli/src/commands/init.ts
  - packages/cli/src/commands/config.ts
  - packages/cli/src/commands/keys.ts
  - packages/cli/src/components/Onboarding.tsx
autonomous: true
requirements:
  - FOUND-01

must_haves:
  truths:
    - "pnpm turbo build completes with no circular dependency warnings between @tek/cli and @tek/gateway"
    - "@tek/gateway no longer depends on @tek/cli"
    - "Vault functions (addKey, getKey, removeKey, listProviders, getOrCreateAuthToken) work identically after extraction"
  artifacts:
    - path: "packages/core/src/vault/index.ts"
      provides: "Vault API (addKey, getKey, updateKey, removeKey, listProviders, getOrCreateAuthToken)"
      exports: ["addKey", "getKey", "updateKey", "removeKey", "listProviders", "getOrCreateAuthToken"]
    - path: "packages/core/src/vault/keychain.ts"
      provides: "OS keychain access (keychainSet, keychainGet, keychainDelete)"
      exports: ["keychainSet", "keychainGet", "keychainDelete"]
    - path: "packages/core/src/vault/providers.ts"
      provides: "Provider type, PROVIDERS list, validateProvider"
      exports: ["PROVIDERS", "Provider", "validateProvider", "PROVIDER_KEY_PREFIXES"]
    - path: "packages/core/package.json"
      provides: "./vault sub-export and @napi-rs/keyring dependency"
      contains: "./vault"
  key_links:
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "@tek/core/vault"
      via: "import"
      pattern: "from [\"']@tek/core/vault[\"']"
    - from: "packages/cli/src/commands/keys.ts"
      to: "@tek/core/vault"
      via: "import"
      pattern: "from [\"']@tek/core/vault[\"']"
---

<objective>
Extract the vault module from @tek/cli to @tek/core to break the circular dependency where @tek/gateway depends on @tek/cli solely for vault access.

Purpose: The circular dependency (@tek/cli <-> @tek/gateway) blocks gateway test isolation and causes Turbo build warnings. Moving vault to @tek/core (which both already depend on) eliminates the cycle.
Output: Vault code in @tek/core with ./vault sub-export; @tek/gateway no longer lists @tek/cli as a dependency.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-foundation-blockers/25-RESEARCH.md
@packages/cli/src/vault/index.ts
@packages/cli/src/vault/keychain.ts
@packages/cli/src/vault/providers.ts
@packages/core/package.json
@packages/core/src/index.ts
@packages/gateway/package.json
@packages/cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move vault files to @tek/core and configure sub-export</name>
  <files>
    packages/core/src/vault/index.ts
    packages/core/src/vault/keychain.ts
    packages/core/src/vault/providers.ts
    packages/core/package.json
    packages/core/tsconfig.json
  </files>
  <action>
    1. Create `packages/core/src/vault/` directory.
    2. Copy `packages/cli/src/vault/providers.ts` to `packages/core/src/vault/providers.ts` — no changes needed (it only imports VaultError from @tek/core, which is the same package now — change to a relative import `../errors.js`).
    3. Copy `packages/cli/src/vault/keychain.ts` to `packages/core/src/vault/keychain.ts` — it imports `Entry` from `@napi-rs/keyring` and `KEYCHAIN_SERVICE` from `@tek/core`. Change the `@tek/core` import to a relative import `../config/index.js`.
    4. Copy `packages/cli/src/vault/index.ts` to `packages/core/src/vault/index.ts` — make these changes:
       - Change `import { createLogger, generateAuthToken, VaultError } from "@tek/core"` to relative imports: `createLogger` from `../logger.js`, `generateAuthToken` from `../crypto/index.js`, `VaultError` from `../errors.js`.
       - **REMOVE** the `import { recordAuditEvent } from "@tek/db"` line entirely. Remove all `recordAuditEvent()` calls from `addKey`, `updateKey`, and `removeKey` functions (3 call sites). This avoids creating a circular dependency @tek/core -> @tek/db -> @tek/core. Audit logging will be handled at call sites (CLI commands, gateway handlers) instead.
       - Keep the `./keychain.js` and `./providers.js` relative imports as-is.
    5. Update `packages/core/package.json`:
       - Add `"./vault"` sub-export: `"./vault": { "import": "./dist/vault/index.js", "types": "./dist/vault/index.d.ts" }`
       - Add `"@napi-rs/keyring": "^1.2.0"` to dependencies.
       - Do NOT add `@tek/db` — that would create a circular dependency.
    6. **CRITICAL:** Do NOT re-export vault from `packages/core/src/index.ts`. The vault sub-export must be a separate entry point (`@tek/core/vault`) so the desktop app (which imports `@tek/core` for config) never encounters the native `@napi-rs/keyring` module.
    7. Ensure `packages/core/tsconfig.json` includes the `src/vault/` directory (it should already include all of `src/`).
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && pnpm turbo build --filter=@tek/core` — should compile without errors and produce `dist/vault/index.js`, `dist/vault/keychain.js`, `dist/vault/providers.js`.
  </verify>
  <done>
    @tek/core builds successfully with vault sub-export. `dist/vault/` directory contains compiled vault files. No @tek/db dependency in @tek/core/package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all vault imports across gateway and CLI</name>
  <files>
    packages/gateway/src/ws/handlers.ts
    packages/gateway/src/llm/provider.ts
    packages/gateway/src/llm/registry.ts
    packages/gateway/src/key-server/auth.ts
    packages/gateway/src/key-server/routes.ts
    packages/gateway/package.json
    packages/cli/src/commands/onboard.ts
    packages/cli/src/commands/init.ts
    packages/cli/src/commands/config.ts
    packages/cli/src/commands/keys.ts
    packages/cli/src/components/Onboarding.tsx
    packages/cli/package.json
  </files>
  <action>
    **Gateway imports (5 files):** Change all `from "@tek/cli/vault"` imports to `from "@tek/core/vault"`:
    - `packages/gateway/src/ws/handlers.ts`
    - `packages/gateway/src/llm/provider.ts`
    - `packages/gateway/src/llm/registry.ts`
    - `packages/gateway/src/key-server/auth.ts`
    - `packages/gateway/src/key-server/routes.ts`

    **Gateway package.json:** Remove `"@tek/cli": "workspace:*"` from dependencies entirely. The gateway should have NO dependency on @tek/cli.

    **CLI imports (5+ files):** Change all relative vault imports to `from "@tek/core/vault"`:
    - `packages/cli/src/commands/onboard.ts`: change `from "../vault/index.js"` (or similar relative) to `from "@tek/core/vault"`
    - `packages/cli/src/commands/init.ts`: same pattern
    - `packages/cli/src/commands/config.ts`: has two imports — one from `../vault/index.js` and one from `../vault/keychain.js` for `keychainSet`. Change both to `from "@tek/core/vault"` (keychainSet is exported from the vault index).
    - `packages/cli/src/commands/keys.ts`: same pattern
    - `packages/cli/src/components/Onboarding.tsx`: same pattern

    **CLI package.json:**
    - Remove the `"./vault"` sub-export from the `"exports"` field (vault is no longer exported from CLI).
    - Remove `@napi-rs/keyring` from dependencies (no longer needed directly — consumed via @tek/core/vault).
    - Keep `@tek/db` dependency in CLI for audit logging at the command level.

    **Add audit logging at CLI call sites:** In `packages/cli/src/commands/keys.ts` (or wherever `addKey`/`updateKey`/`removeKey` are called), add `recordAuditEvent()` calls AFTER the vault operation. Import `recordAuditEvent` from `@tek/db`. This preserves the audit trail that was previously inside vault functions.

    **Delete old vault files:** Remove `packages/cli/src/vault/` directory entirely (index.ts, keychain.ts, providers.ts).
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && pnpm turbo build` — full monorepo build should complete with no circular dependency warnings. Grep for any remaining `@tek/cli/vault` imports: `grep -r "@tek/cli/vault" packages/` should return nothing.
  </verify>
  <done>
    All vault imports point to @tek/core/vault. @tek/gateway has no @tek/cli dependency. @tek/cli has no vault directory. `pnpm turbo build` completes in one pass with no circular dependency warnings.
  </done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` completes successfully with no circular dependency warnings
2. `grep -r "@tek/cli/vault" packages/` returns no results
3. `grep -r "@tek/cli" packages/gateway/package.json` returns no results
4. `ls packages/core/dist/vault/` shows index.js, keychain.js, providers.js
5. `ls packages/cli/src/vault/` returns "No such file or directory"
</verification>

<success_criteria>
- @tek/gateway no longer depends on @tek/cli
- Vault code lives in @tek/core with ./vault sub-export
- All import sites updated across gateway (5 files) and CLI (5+ files)
- pnpm turbo build completes cleanly with no circular dependency warnings
- Audit logging preserved at CLI command call sites
</success_criteria>

<output>
After completion, create `.planning/phases/25-foundation-blockers/25-01-SUMMARY.md`
</output>
