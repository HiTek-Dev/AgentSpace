---
phase: 07-agent-self-improvement
plan: 04
type: execute
wave: 2
depends_on: ["07-03"]
files_modified:
  - packages/gateway/src/ws/protocol.ts
  - packages/gateway/src/agent/tool-loop.ts
  - packages/cli/src/lib/pty-proxy.ts
  - packages/cli/src/components/Chat.tsx
autonomous: true

must_haves:
  truths:
    - "Agent can observe terminal output from a proxied PTY session via terminal.snapshot WS messages"
    - "Agent can send keystrokes to the PTY session via terminal.input WS messages"
    - "User can reclaim exclusive control of the PTY session at any time with Ctrl+backslash"
    - "Terminal snapshots strip ANSI escape codes before sending to the agent for readability"
    - "Agent terminal control requires explicit user grant before the agent can send input"
  artifacts:
    - path: "packages/gateway/src/ws/protocol.ts"
      provides: "terminal.snapshot, terminal.input, terminal.control.grant, terminal.control.revoke message schemas"
      contains: "terminal.snapshot"
    - path: "packages/cli/src/lib/pty-proxy.ts"
      provides: "Agent-observable PTY mode with snapshot emission and input injection"
      exports: ["runPtyProxy", "PtyProxyOptions"]
    - path: "packages/gateway/src/agent/tool-loop.ts"
      provides: "Terminal observation context injection"
      contains: "terminal.snapshot"
  key_links:
    - from: "packages/cli/src/lib/pty-proxy.ts"
      to: "packages/gateway/src/ws/protocol.ts"
      via: "terminal.snapshot messages sent over WS"
      pattern: "terminal\\.snapshot"
    - from: "packages/gateway/src/ws/protocol.ts"
      to: "packages/cli/src/lib/pty-proxy.ts"
      via: "terminal.input messages received and forwarded to PTY"
      pattern: "terminal\\.input"
---

<objective>
Enable the agent to observe and interact with proxied terminal sessions, allowing it to read PTY output and send keystrokes when given explicit user control.

Purpose: CLI-06 requires the agent to observe PTY sessions and optionally control them. The CLI holds the PTY (node-pty requires a real TTY) and communicates with the gateway over WebSocket using snapshot/input messages.

Output: WS protocol extensions for terminal messages, enhanced pty-proxy with agent observation mode, and gateway handler for terminal input forwarding.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-agent-self-improvement/07-03-PLAN.md
@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/agent/tool-loop.ts
@packages/cli/src/lib/pty-proxy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add terminal WS protocol messages and gateway handler</name>
  <files>
    packages/gateway/src/ws/protocol.ts
    packages/gateway/src/ws/server.ts
  </files>
  <action>
**protocol.ts — Add terminal message schemas:**

Client messages (from CLI to gateway):
```typescript
const TerminalSnapshotSchema = z.object({
  type: z.literal("terminal.snapshot"),
  id: z.string(),
  sessionId: z.string(),
  content: z.string(),          // ANSI-stripped terminal output
  timestamp: z.number(),        // Date.now()
});

const TerminalControlGrantSchema = z.object({
  type: z.literal("terminal.control.grant"),
  id: z.string(),
  sessionId: z.string(),
});

const TerminalControlRevokeSchema = z.object({
  type: z.literal("terminal.control.revoke"),
  id: z.string(),
  sessionId: z.string(),
});
```

Add all three to `ClientMessageSchema` discriminated union.

Server messages (from gateway to CLI):
```typescript
const TerminalInputSchema = z.object({
  type: z.literal("terminal.input"),
  requestId: z.string(),
  data: z.string(),             // Keystrokes to inject into PTY
});

const TerminalProxyStartSchema = z.object({
  type: z.literal("terminal.proxy.start"),
  requestId: z.string(),
  command: z.string(),
  args: z.array(z.string()).optional(),
});
```

Add both to `ServerMessageSchema` discriminated union.

**server.ts — Add terminal message handler:**

In the WS message handler switch, add cases:

- `terminal.snapshot`: Store the latest snapshot on `ConnectionState` (add `lastTerminalSnapshot: string | null` field to `ConnectionState` in connection.ts). This allows the agent to read terminal state when needed. Also store `terminalControlGranted: boolean` on ConnectionState (default false).

- `terminal.control.grant`: Set `connState.terminalControlGranted = true`. Log it.

- `terminal.control.revoke`: Set `connState.terminalControlGranted = false`. Log it.

The gateway doesn't need to actively process snapshots for the agent — the agent reads them via the tool loop context. But storing the latest snapshot enables a future `read_terminal` tool.

**connection.ts — Extend ConnectionState:**

Add:
```typescript
lastTerminalSnapshot: string | null;
terminalControlGranted: boolean;
```

Initialize both as `null` and `false` in `initConnection`.
  </action>
  <verify>
`cd /Users/hitekmedia/Documents/GitHub/AgentSpace && npx tsc --noEmit -p packages/gateway/tsconfig.json` compiles. `grep -r "terminal\\.snapshot\|terminal\\.input\|terminal\\.control" packages/gateway/src/ws/protocol.ts` — all schemas present.
  </verify>
  <done>WS protocol includes terminal.snapshot, terminal.input, terminal.control.grant/revoke messages. ConnectionState tracks terminal snapshot and control grant state. Server handles incoming terminal messages.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance pty-proxy with agent observation and input injection</name>
  <files>
    packages/cli/src/lib/pty-proxy.ts
    packages/cli/src/components/Chat.tsx
  </files>
  <action>
**pty-proxy.ts — Add agent observation mode:**

Extend `PtyProxyOptions` with:
```typescript
export interface PtyProxyOptions {
  command: string;
  args?: string[];
  cwd?: string;
  cols?: number;
  rows?: number;
  env?: Record<string, string>;
  /** If provided, PTY output snapshots are sent to this callback (ANSI-stripped). */
  onSnapshot?: (content: string) => void;
  /** If provided, agent input is injected from this event source. */
  onAgentInput?: (handler: (data: string) => void) => (() => void);  // returns cleanup
}
```

In `runPtyProxy`:

1. **ANSI stripping for snapshots:** Create a simple ANSI strip function:
   ```typescript
   function stripAnsi(str: string): string {
     return str.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, "")
               .replace(/\x1b\][^\x07]*\x07/g, "");  // OSC sequences
   }
   ```

2. **Snapshot emission:** Maintain a rolling buffer of the last ~4000 chars of ANSI-stripped output. In the `ptyProcess.onData` handler, after writing to stdout, also append stripped text to the buffer and call `opts.onSnapshot?.(buffer)` throttled to every 500ms (use a simple `setTimeout` debounce — don't send on every keystroke).

3. **Agent input injection:** If `opts.onAgentInput` is provided, call it with a handler function `(data: string) => ptyProcess.write(data)`. Store the cleanup function and call it on PTY exit.

4. **Ctrl+backslash (SIGQUIT) for user reclaim:** In the stdin data handler, detect `\x1c` (Ctrl+\). When detected:
   - If agent control is active, call a `onControlRevoke?.()` callback (add to PtyProxyOptions)
   - Do NOT forward `\x1c` to the PTY (consume it)
   - Log: "[proxy] Agent control revoked — you have exclusive control"

**Chat.tsx — Wire agent observation in /proxy command:**

When `/proxy` is invoked with `--agent` flag (e.g., `/proxy --agent vim file.txt`):

1. Pass the WebSocket send function to pty-proxy options:
   - `onSnapshot`: sends `terminal.snapshot` message over WS
   - `onAgentInput`: registers a WS message listener for `terminal.input` messages and returns cleanup
   - `onControlRevoke`: sends `terminal.control.revoke` message over WS

2. After PTY spawns, send `terminal.control.grant` over WS (agent can now observe and send input).

3. On Ctrl+\, send `terminal.control.revoke` — agent loses input ability but can still observe.

If `/proxy` is invoked without `--agent`, the PTY runs in user-only mode (no snapshots, no agent input) — same as plan 03 behavior.

Note: Since Ink is unmounted during PTY mode, the WS connection must be managed outside of Ink. The chat command entrypoint holds the raw WS connection and passes the send/listen callbacks to `runPtyProxy`. This may require refactoring the chat command to keep the WS connection alive after Ink unmounts.

Implementation approach for the chat command entrypoint:
1. Before rendering Ink, establish the WS connection and store it
2. Pass WS callbacks to Chat via props
3. After Ink unmounts for /proxy, the WS connection is still alive
4. Pass WS send/listen to runPtyProxy options
5. After PTY exits, close WS or re-render Ink
  </action>
  <verify>
`cd /Users/hitekmedia/Documents/GitHub/AgentSpace && npx tsc --noEmit -p packages/cli/tsconfig.json` compiles. `grep -r "onSnapshot\|onAgentInput\|stripAnsi" packages/cli/src/lib/pty-proxy.ts` — all present. `grep -r "terminal\\.control" packages/cli/src/` — grant/revoke messages sent.
  </verify>
  <done>PTY proxy supports agent observation mode with ANSI-stripped snapshots, agent input injection, and Ctrl+backslash user reclaim. /proxy --agent flag enables agent interaction. WS connection persists through Ink unmount for terminal messaging.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` — gateway compiles with terminal protocol
2. `npx tsc --noEmit -p packages/cli/tsconfig.json` — CLI compiles with enhanced pty-proxy
3. `grep -r "terminal\\.snapshot" packages/gateway/src/ws/protocol.ts` — schema present
4. `grep -r "terminal\\.input" packages/gateway/src/ws/protocol.ts` — schema present
5. `grep -r "stripAnsi" packages/cli/src/lib/pty-proxy.ts` — ANSI stripping implemented
6. `grep -r "onAgentInput" packages/cli/src/lib/pty-proxy.ts` — agent input injection supported
7. `grep -r "\\\\x1c" packages/cli/src/lib/pty-proxy.ts` — Ctrl+backslash detection
</verification>

<success_criteria>
- Terminal WS protocol messages are defined for snapshot, input, control grant/revoke
- PTY proxy emits throttled ANSI-stripped snapshots when agent observation is enabled
- Agent can inject keystrokes via terminal.input messages
- User can revoke agent control with Ctrl+backslash
- /proxy --agent flag enables observation mode
- ConnectionState tracks terminal state
- All packages compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-agent-self-improvement/07-04-SUMMARY.md`
</output>
